// Peity jQuery plugin version 1.2.1
// (c) 2013 Ben Pickles
//
// http://benpickles.github.io/peity
//
// Released under MIT license.
(function(v,m){var L=document.createElement("canvas").getContext,w=v.fn.peity=function(a,b){L&&this.each(function(){var c=v(this),d=c.data("peity");if(d)a&&(d.type=a),v.extend(!0,d.opt,b),d.draw();else{var f=w.defaults[a],e={};v.each(c.data(),function(a,b){e[a]=b});f=v.extend(!0,{},f,e,b);d=new D(c,a,f);d.draw();c.change(function(){d.draw()}).data("peity",d)}});return this},D=function(a,b,c){this.$el=a;this.type=b;this.opt=c},A=D.prototype;A.fill=function(){var a=this.opt.fill;return v.isFunction(a)?
a:function(b,c){return a[c%a.length]}};A.draw=function(){w.graphers[this.type].call(this,this.opt)};A.prepareCanvas=function(a,b){var c=this.canvas;if(c)c.width=c.width;else{var d=v("<canvas class='peity'>").css({height:b,width:a}).data("peity",this);this.canvas=c=d[0];this.context=c.getContext("2d");this.$el.hide().after(c);c.height=d.height();c.width=d.width()}return c};A.values=function(){var a=arguments,b=this.$el.text().split(a[0]);return 1===a.length?r.parseFloats(b):b.map(function(b){return r.parseFloats(b.split(a[1]))})};
var r={defaultText:{color:"#000",size:13,formatter:function(a){return a}},labelLeveler:function(a){return m.max.apply(this,a.map(function(a){return a.replace(/[^ ]/g,"").length}))+1},stringifier:function(a,b){return b?a.map(function(a){return b(a)+""}):a.map(function(a){return a+""})},parseFloats:function(a){return a.map(function(a){return parseFloat(a)})},extractor:function(a){return function(b){return b[a]}}},K=function(a){var b=this.getBoundingClientRect();v(this).off().prev().data("mouse",JSON.stringify({x:a.clientX-
b.left,y:a.clientY-b.top})).change()},I=function(a){v(a).on("mousemove",K).on("mouseout",K)},x={arc:function(a,b,c,d,f,e,k,h){a.beginPath();a.arc(b,c,d,f,e,!0);a.lineWidth=h;a.strokeStyle=k;a.stroke()},circle:function(a,b,c,d,f,e,k){a.beginPath();a.moveTo(b,c);a.arc(b,c,d,f,e,!0);a.fillStyle=k;a.fill()},line:function(a,b,c,d){var f;a.beginPath();a.moveTo(b[0].x,b[0].y);for(f=1;f<b.length;f++)a.lineTo(b[f].x,b[f].y);a.lineWidth=d;a.strokeStyle=c;a.stroke()},rect:function(a,b,c,d,f,e,k,h){e&&(a.fillStyle=
e,a.fillRect(b,c,d,f));h&&(a.strokeStyle=h,a.lineWidth=k,a.strokeRect(b,c,d,f))},drawYAxis:function(a,b,c,d,f,e,k,h,n,p,s,q,m,u,t,g){var l=s-q*(0-m)+g;b&&x.line(a,[{x:n,y:l},{x:p,y:l}],d,b);if(c)for(a.fillStyle=e,a.font=k+"px sans-serif",a.textAlign="right",b=m;b<=u;b+=t)l=s-q*(b-m)+g,x.line(a,[{x:n,y:l},{x:p,y:l}],f,c),n&&(a.textBaseline=l>k/2?l>s-k/2?"bottom":"middle":"top",a.fillText(h(b)+"",n-2,l))},drawXAxis:function(a,b,c,d,f,e){var k,h;a.fillStyle=b;a.font=c+"px sans-serif";a.textBaseline=
"top";a.textAlign="center";for(b=0;b<f.length;b++)for(h=e[b].split(" "),k=0;k<h.length;k++)a.fillText(h[k],f[b].x,d+1+k*c)},tooltip:function(a,b,c,d,f,e,k,h){a.font=e+"px sans-serif";a.textAlign="left";a.textBaseline="top";var n=a.measureText("\u25a0").width;h=r.stringifier(d,h);var p=m.max.apply([],h.map(function(b){return a.measureText(b).width}));b-=6;c>d.length*e+6&&(c-=d.length*e);b<=p+n+7&&(b+=p+n+20+7);x.rect(a,b-p-n-4,c-3,p+n+7,d.length*e+8,"#fff",1,"#000");h.forEach(function(d,h){a.fillStyle=
f[h%f.length];a.fillText("\u25a0",b-p-n-3,c+h*e);a.fillStyle=k;a.fillText(d,b-p-2,c+h*e)})}};w.defaults={};w.graphers={};w.register=function(a,b,c){this.defaults[a]=b;this.graphers[a]=c};w.register("pie",{fill:["#f90","#ffd","#fc6"],line:{color:"#000",width:0},focus:{color:"#000",width:0},delimiter:null,diameter:16,tooltip:r.defaultText},function(a){var b=a.delimiter;b||(b=(b=this.$el.text().match(/[^0-9\.]/))?b[0]:",");var c=this.values.apply(this,[b]);"/"===b&&(c=[c[0],c[1]-c[0]]);var d,f=0,b=c.length;
for(d=0;d<b;d++)f+=c[d];var e=this.$el.data("mouse"),k=a.focus,h=a.line,n=m.max(k.width,h.width)+1,p=a.diameter,p=this.prepareCanvas(p+n,p+n),s=this.context;d=p.width;var q=p.height,n=d/2-n,r=2*m.PI,f=r/f,u=this.fill();a=a.tooltip;var t;if(k.width&&e){e=JSON.parse(e);e.x-=d/2;e.y-=q/2;e.y*=-1;e.r=m.sqrt(e.x*e.x+e.y*e.y);for(e.a=m.atan2(e.y,e.x);0>e.a;)e.a+=r;for(;e.a>r;)e.a-=r}s.save();s.translate(d/2,q/2);var g,l=0;for(d=0;d<b;d++)q=c[d],g=q*f,x.circle(s,0,0,n,-l,-(l+g),u.call(this,q,d,c)),k.width&&
e&&e.a>l&&e.a<l+g&&e.r<n&&(x.arc(s,0,0,n+k.width/2,-l,-(l+g),k.color,k.width),t=d),l+=g;h.width&&x.arc(s,0,0,n+h.width/2,0,r,h.color,h.width);k.width&&(e&&void 0!==t&&(e=JSON.parse(this.$el.data("mouse")),s.restore(),x.tooltip(s,e.x,e.y,[c[t]],[u.call(this,c[t],t,c)],a.size,a.color,a.formatter)),I(p))});w.register("lines",{lineColors:["#78A","#827"],lineWidths:[1],fill:"#cdf",delimiters:["|",","],height:32,width:32,left:0,max:null,min:0,pointSizes:[2],xAxis:r.defaultText,yAxis:r.defaultText,tooltip:r.defaultText,
focus:!1,gridlines:{widths:[1,0],colors:["#000","#bbb"]}},function(a){var b=this.$el.data("mouse"),c=this.values.apply(this,a.delimiters),d,f=a.pointSizes,e=a.xAxis,k=a.yAxis,h=a.focus,n=a.tooltip,p=a.gridlines,s=[].concat.apply([a.max,a.min],c),q=a.labels;q&&(q=r.stringifier(q));var v=0;q&&(v=r.labelLeveler(q));var u=m.max.apply(m,s),t=m.min.apply(m,s),g=a.region||(u-t)/5,u=m.ceil(u/g)*g,t=m.floor(t/g)*g,s=this.prepareCanvas(a.width,a.height),l=this.context,G=a.left,z=v*e.size+(v?4:0),w=s.width,
B=w-2*m.max.apply(m,f)-G,z=s.height-z,B=B/(c[0].length-0.5),H=z/(u-t),E=a.lineColors,A=a.lineWidths,D=a.fill,y,J,C,F=[];for(y=0;y<c.length;y+=1){J=c[y];C=[];for(a=0;a<J.length;a++)d=J[a],C.push({x:a*B+f[y%f.length]+G+B/4,y:z-H*(d-t)});if(D&&1===c.length){l.beginPath();d=0;l.moveTo(G+B/4+f[0],z-H*(d-t));for(a=0;a<C.length;a++)l.lineTo(C[a].x,C[a].y);d=0;l.lineTo(w-f[0]-B/4,z-H*(d-t));l.fillStyle=D;l.fill()}F.push(C)}x.drawYAxis(l,p.widths[0],p.widths[1],p.colors[0],p.colors[1],k.color,k.size,k.formatter,
G,w,z,H,t,u,g,0);for(y=0;y<c.length;y+=1){C=F[y];for(a=0;a<C.length;a++)x.circle(l,C[a].x,C[a].y,f[y%f.length],0,2*m.PI,E[y%E.length]);x.line(l,C,E[y%E.length],A[y%A.length])}v&&x.drawXAxis(l,e.color,e.size,z,F[0],q);if(h&&b)for(b=JSON.parse(b),a=0;a<F[0].length;a++)if(f=F[0][a],b.x>=f.x-B/3&&b.x<=f.x+B/3){x.tooltip(l,b.x,b.y,c.map(r.extractor(a)),E,n.size,n.color,n.formatter);break}h&&I(s)});w.register("bar",{fill:["#48f"],delimiter:",",height:16,width:32,left:0,gap:1,max:null,min:0,xAxis:r.defaultText,
yAxis:r.defaultText,focus:{color:"#000",width:0},tooltip:r.defaultText,gridlines:{widths:[1,0],colors:["#000","#bbb"]}},function(a){var b,c,d=this.values.apply(this,[a.delimiter]),f=a.labels,e=0;f&&(f=r.stringifier(f),e=r.labelLeveler(f));b=m.max.apply(m,d.concat([a.max]));var k=m.min.apply(m,d.concat([a.min]));c=a.region||(b-k)/5;b=m.ceil(b/c)*c;var k=m.floor(k/c)*c,h=this.$el.data("mouse"),n=this.prepareCanvas(a.width,a.height),p=this.context,s=this.fill(),q=a.yAxis,v=a.xAxis,u=a.focus,t=a.tooltip,
g=a.gridlines,l=n.width,w=a.gap;a=a.left;var z=n.height-(e*v.size+(e?4:0))-g.widths[0],A=z/(b-k),B=(l-2*w-a+w)/d.length;x.drawYAxis(p,g.widths[0],g.widths[1],g.colors[0],g.colors[1],q.color,q.size,q.formatter,a,l,z,A,k,b,c,0);q=[];for(b=0;b<d.length;b++)c=d[b],g=[a+b*B+w,z-A*(c-k),B-w,0===c?1:A*c],q.push(g),x.rect(p,g[0],g[1],g[2],g[3],s.call(this,c,b,d),0);e&&x.drawXAxis(p,v.color,v.size,z,q.map(function(a){return{x:a[0]+a[2]/2}}),f);if(u.width&&h)for(h=JSON.parse(h),b=0;b<q.length;b++)if(g=q[b],
h.x>=g[0]&&h.x<=g[0]+g[2]){g[1]+=m.min(g[3],0);g[3]=m.abs(g[3]);h.y>=g[1]&&h.y<=g[1]+g[3]&&(c=d[b],x.rect(p,g[0]-u.width/2,g[1]-u.width/2,g[2]+u.width,g[3]+u.width,void 0,u.width,u.color),x.tooltip(p,h.x,h.y,[d[b]],[s.call(this,c,b,d)],t.size,t.color,t.formatter));break}u.width&&I(n)})})(jQuery,Math);
