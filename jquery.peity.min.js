// Peity jQuery plugin version 1.2.1
// (c) 2013 Ben Pickles
//
// http://benpickles.github.io/peity
//
// Released under MIT license.
(function(r,n){var G=document.createElement("canvas").getContext,w=r.fn.peity=function(a,b){G&&this.each(function(){var c=r(this),e=c.data("peity");if(e)a&&(e.type=a),r.extend(!0,e.opt,b),e.draw();else{var f=w.defaults[a],d={};r.each(c.data(),function(a,b){a in f&&(d[a]=b)});var q=r.extend(!0,{},f,d,b),e=new F(c,a,q);e.draw();c.change(function(a,b,c){e.draw()}).data("peity",e)}});return this},F=function(a,b,c){this.$el=a;this.type=b;this.opt=c},h=F.prototype;h.fill=function(){var a=this.opt.fill;
return r.isFunction(a)?a:function(b,c){return a[c%a.length]}};h.draw=function(){w.graphers[this.type].call(this,this.opt)};h.prepareCanvas=function(a,b){var c=this.canvas,e;c?c.width=c.width:(e=r("<canvas>").css({height:b,width:a}).addClass("peity").data("peity",this),this.canvas=c=e[0],this.context=c.getContext("2d"),this.$el.hide().after(c),c.height=e.height(),c.width=e.width());return c};h.hoverEvent=function(a){h.removeEvents(this);var b=this.getBoundingClientRect();r(this).prev().data("mouse",
JSON.stringify({x:a.clientX-b.left,y:a.clientY-b.top})).change()};h.exitEvent=function(a){h.removeEvents(this);r(this).prev().removeData("mouse").change()};h.removeEvents=function(a){a.removeEventListener("mouseout",a.exitEvent,!1);a.removeEventListener("mousemove",a.hoverEvent,!1)};h.addEvents=function(a){a.addEventListener("mousemove",h.hoverEvent,!1);a.addEventListener("mouseout",h.exitEvent,!1)};h.values=function(){var a=this.opt.delimiter,b=this.opt.seriesDelimiter,c=this.$el.text(),e=function(b){return b.split(a).map(function(a){return parseFloat(a)})};
return b?c.split(b).map(e):e(c)};h.setLineStyle=function(a,b,c){a.lineWidth=c;a.strokeStyle=b};h.drawArc=function(a,b,c,e,f,d,q,m){a.beginPath();a.arc(b,c,e,f,d,!0);h.setLineStyle(a,q,m);a.stroke()};h.drawCircle=function(a,b,c,e,f,d,q){a.beginPath();a.moveTo(b,c);a.arc(b,c,e,f,d,!0);a.fillStyle=q;a.fill()};h.drawLine=function(a,b,c,e){a.beginPath();a.moveTo(b[0].x,b[0].y);for(var f=1;f<b.length;f++)a.lineTo(b[f].x,b[f].y);this.setLineStyle(a,c,e);a.stroke()};h.drawYAxis=function(a,b,c,e,f,d,q,m,k,
n,l,h,s,t,x,g){var v=function(){return l-h*(u-s)+g},u=0;b&&(a.beginPath(),a.moveTo(k,v()),a.lineTo(n,v()),this.setLineStyle(a,e,b),a.stroke());if(c)for(this.setLineStyle(a,f,c),u=s;u<=t;u+=x)a.beginPath(),a.moveTo(k,v()),a.lineTo(n,v()),a.stroke(),3<k&&(a.fillStyle=d,a.font=q+"px sans-serif",a.textAlign="right",a.textBaseline=v()>q/2?v()>l-q/2?"bottom":"middle":"top",a.fillText(m(u)+"",k-1,v()))};h.drawXAxis=function(a,b,c,e,f,d){a.fillStyle=b;a.font=c+"px sans-serif";a.textBaseline="top";a.textAlign=
"center";for(b=0;b<f.length;b++)for(var q=d[b].split(" "),m=0;m<q.length;m++)a.fillText(q[m],f[b].x,e+1+m*c)};w.defaults={};w.graphers={};w.register=function(a,b,c){this.defaults[a]=b;this.graphers[a]=c};w.register("pie",{fill:["#f90","#ffd","#fc6"],lineColor:"#000",lineWidth:0,focusColor:"#000",focusWidth:0,delimiter:null,diameter:16},function(a){if(!a.delimiter){var b=this.$el.text().match(/[^0-9\.]/);a.delimiter=b?b[0]:","}b=this.values();"/"===a.delimiter&&(b=[b[0],b[1]-b[0]]);var c,e=0,f=b.length;
for(c=0;c<f;c++)e+=b[c];var d=this.$el.data("mouse"),q=a.focusWidth,m=a.lineWidth,k=n.max(q,m)+1,h=a.diameter,h=this.prepareCanvas(h+k,h+k),l=this.context;c=h.width;var y=h.height,k=c/2-k,s=2*n.PI,e=s/e,t=this.fill();if(q&&d){d=JSON.parse(d);d.x-=c/2;d.y-=y/2;d.y*=-1;d.r=n.sqrt(d.x*d.x+d.y*d.y);for(d.a=n.atan2(d.y,d.x);0>d.a;)d.a+=s;for(;d.a>s;)d.a-=s}l.translate(c/2,y/2);var x,g=0;for(c=0;c<f;c++)y=b[c],x=y*e,this.drawCircle(l,0,0,k,-g,-(g+x),t.call(this,y,c,b)),q&&d&&d.a>g&&d.a<g+x&&this.drawArc(l,
0,0,k+q/2,-g,-(g+x),a.focusColor,q),g+=x;m&&this.drawArc(l,0,0,k+m/2,0,s,a.lineColor,m);q&&this.addEvents(h)});w.register("line",{fill:"#cdf",lineColor:"#48f",lineWidth:1,delimiter:",",height:16,width:32,left:0,max:null,min:0,pointSize:2,focus:!1,xAxis:{color:"#000",size:13,formatter:function(a){return a}},yAxis:{color:"#000",size:13,formatter:function(a){return a}},focus:!1,tooltip:{color:"#000",size:13,formatter:function(a){return a}},gridlines:{widths:[1,0],colors:["#000","#bbb"]}},function(a){var b=
this.$el.data("mouse"),c=this.values();1==c.length&&c.push(c[0]);var e=a.labels;e&&(e=e.map(function(a){return a+""}));var f=0;e&&(f=n.max.apply(this,e.map(function(a){return a.replace(/[^ ]/g,"").length}))+1);var d=n.max.apply(n,c.concat([a.max])),q=n.min.apply(n,c.concat([a.min])),m=a.region||(d-q)/5,k=a.lineWidth,h=a.pointSize,l=a.xAxis,y=a.yAxis,s=a.tooltip,t=a.gridlines,x=this.prepareCanvas(a.width,a.height),g=this.context,v=a.left+h,u=x.width,E=x.height-k-(f*l.size+(f?4:0)),z=(u-h-v)/(c.length-
1),C=E/(d-q),A=E+q*C,B=[],p;g.beginPath();g.moveTo(v,A);for(p=0;p<c.length;p++){var D=p*z+v,r=A-C*c[p]+k/2;B.push({x:D,y:r});g.lineTo(D,r)}g.lineTo(u-h/2,A);a.fill&&(g.fillStyle=a.fill,g.fill());this.drawYAxis(g,t.widths[0],t.widths[1],t.colors[0],t.colors[1],y.color,y.size,y.formatter,v,u,E,C,q,d,m,0);k&&this.drawLine(g,B,a.lineColor,k);if(a.pointSize)for(p=0;p<B.length;p++)this.drawCircle(g,B[p].x,B[p].y,a.pointSize,0,2*n.PI,a.lineColor);f&&this.drawXAxis(g,l.color,l.size,E,B,e);if(a.focus&&b)for(b=
JSON.parse(b),p=0;p<B.length;p++)if(e=B[p],b.x>=e.x-z/3&&b.x<=e.x+z/3){g.fillStyle=s.color;g.font=s.size+"px sans-serif";b.x>u/2&&(g.textAlign="right");b.y<E/2&&(g.textBaseline="top",b.y+=20);g.fillText(s.formatter(c[p])+"",b.x,b.y);break}a.focus&&this.addEvents(x)});w.register("lines",{lineColors:["#666666","#803E75"],lineWidths:[1],delimiter:",",seriesDelimiter:"|",height:32,width:32,left:0,max:null,min:0,pointSizes:[2],xAxis:{color:"#000",size:13,formatter:function(a){return a}},yAxis:{color:"#000",
size:13,formatter:function(a){return a}},focus:!1,tooltip:{color:"#000",size:13,formatter:function(a){return a}},gridlines:{widths:[1,0],colors:["#000","#bbb"]}},function(a){var b=this.$el.data("mouse"),c=this.values(),e=a.pointSizes,f=a.xAxis,d=a.yAxis,h=a.focus,m=a.tooltip,k=a.gridlines,r=[].concat.apply([a.max,a.min],c),l=a.labels;l&&(l=l.map(function(a){return a+""}));var y=0;l&&(y=n.max.apply(this,l.map(function(a){return a.replace(/[^ ]/g,"").length}))+1);var s=n.max.apply(n,r),t=n.min.apply(n,
r),x=a.region||(s-t)/5,r=this.prepareCanvas(a.width,a.height),g=this.context,v=a.left,u=y*f.size+(y?4:0),E=r.width,z=E-2*n.max.apply(n,e)-v,u=r.height-u,z=z/(c[0].length-0.5),C=u/(s-t),A=a.lineColors,B=a.lineWidths,k=a.gridlines,p,D,w;this.drawYAxis(g,k.widths[0],k.widths[1],k.colors[0],k.colors[1],d.color,d.size,d.formatter,v,E,u,C,t,s,x,0);for(d=0;d<c.length;d+=1){s=c[d];D=[];for(p=0;p<s.length;p++)a=s[p],D.push({x:p*z+e[d%e.length]+v+z/4,y:u-C*(a-t)}),this.drawCircle(g,D[p].x,D[p].y,e[d%e.length],
0,2*n.PI,A[d%A.length]);this.drawLine(g,D,A[d%A.length],B[d%B.length]);0===d&&(w=D.slice(0))}y&&this.drawXAxis(g,f.color,f.size,u,D,l);if(h&&b)for(b=JSON.parse(b),p=0;p<w.length;p++)if(e=w[p],b.x>=e.x-z/3&&b.x<=e.x+z/3){g.font=m.size+"px sans-serif";g.textAlign="right";b.y<u/2?(g.textBaseline="top",b.y+=m.size):(g.textBaseline="bottom",b.y-=m.size);c.forEach(function(a,c){g.fillStyle=A[c%A.length];g.fillText((m.formatter(a[p])||" ")+" \u25a0",b.x,b.y+c*m.size)});break}h&&this.addEvents(r)});w.register("bar",
{fill:["#48f"],delimiter:",",height:16,width:32,left:0,gap:1,xAxis:{color:"#000",size:13,formatter:function(a){return a}},yAxis:{color:"#000",size:13,formatter:function(a){return a}},focus:{color:"#000",width:0},tooltip:{color:"#000",size:13,formatter:function(a){return a}},gridlines:{widths:[1,0],colors:["#000","#bbb"]},max:null,min:0},function(a){var b,c,e=this.values(),f=a.labels;f&&(f=f.map(function(a){return a+""}));var d=0;f&&(d=n.max.apply(this,f.map(function(a){return a.replace(/[^ ]/g,"").length}))+
1);b=n.max.apply(n,e.concat([a.max]));var h=n.min.apply(n,e.concat([a.min])),m=a.region||(b-h)/5,k=this.$el.data("mouse"),r=this.prepareCanvas(a.width,a.height),l=this.context,y=this.fill();c=a.yAxis;var s=a.xAxis,t=a.focus,x=a.tooltip,g=a.gridlines,v=r.width,u=r.height,w=a.gap;a=a.left;var z=u-(d*s.size+(d?4:0))-g.widths[0],C=z/(b-h),A=(v-2*w-a+w)/e.length;this.drawYAxis(l,g.widths[0],g.widths[1],g.colors[0],g.colors[1],c.color,c.size,c.formatter,a,v,z,C,h,b,m,0);m=[];for(b=0;b<e.length;b++)c=e[b],
m.push([a+b*A+w,z-C*(c-h),A-w,0===c?1:C*c]),l.fillStyle=y.call(this,c,b,e),l.fillRect.apply(l,m[b]);d&&this.drawXAxis(l,s.color,s.size,z,m.map(function(a){return{x:a[0]+a[2]/2}}),f);if(t.width&&k)for(k=JSON.parse(k),b=0;b<m.length;b++)if(f=m[b],k.x>=f[0]&&k.x<=f[0]+f[2]){f[1]+=n.min(f[3],0);f[3]=n.abs(f[3]);k.y>=f[1]&&k.y<=f[1]+f[3]&&(this.setLineStyle(l,t.color,t.width),l.strokeRect(f[0]-t.width/2,f[1]-t.width/2,f[2]+t.width,f[3]+t.width),l.fillStyle=x.color,l.font=x.size+"px sans-serif",k.x>v/2&&
(l.textAlign="right"),k.y<u/2?(l.textBaseline="top",k.y+=20):l.textBaseline="bottom",l.fillText(x.formatter(e[b])+"",k.x,k.y));break}t.width&&this.addEvents(r)})})(jQuery,Math);
