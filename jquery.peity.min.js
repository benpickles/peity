// Peity jQuery plugin version 1.2.1
// (c) 2013 Ben Pickles
//
// http://benpickles.github.io/peity
//
// Released under MIT license.
(function(x,l){var K=document.createElement("canvas").getContext,v=x.fn.peity=function(a,b){K&&this.each(function(){var c=x(this),d=c.data("peity");if(d)a&&(d.type=a),x.extend(!0,d.opt,b),d.draw();else{var f=v.defaults[a],e={};x.each(c.data(),function(a,b){a in f&&(e[a]=b)});var g=x.extend(!0,{},f,e,b),d=new D(c,a,g);d.draw();c.change(function(a,b,c){d.draw()}).data("peity",d)}});return this},D=function(a,b,c){this.$el=a;this.type=b;this.opt=c},r=D.prototype;r.fill=function(){var a=this.opt.fill;
return x.isFunction(a)?a:function(b,c){return a[c%a.length]}};r.draw=function(){v.graphers[this.type].call(this,this.opt)};r.prepareCanvas=function(a,b){var c=this.canvas;if(c)c.width=c.width;else{var d=x("<canvas>").css({height:b,width:a}).addClass("peity").data("peity",this);this.canvas=c=d[0];this.context=c.getContext("2d");this.$el.hide().after(c);c.height=d.height();c.width=d.width()}return c};r.values=function(){var a=function(a){return parseFloat(a)},b=arguments,c=this.$el.text().split(b[0]);
return 1===b.length?c.map(a):c.map(function(c){return c.split(b[1]).map(a)})};var r={color:"#000",size:13,formatter:function(a){return a}},J=function(a){var b=this.getBoundingClientRect();x(this).off().prev().data("mouse",JSON.stringify({x:a.clientX-b.left,y:a.clientY-b.top})).change()},H=function(a){x(a).on("mousemove",J).on("mouseout",J)},y={arc:function(a,b,c,d,f,e,g,h){a.beginPath();a.arc(b,c,d,f,e,!0);a.lineWidth=h;a.strokeStyle=g;a.stroke()},circle:function(a,b,c,d,f,e,g){a.beginPath();a.moveTo(b,
c);a.arc(b,c,d,f,e,!0);a.fillStyle=g;a.fill()},line:function(a,b,c,d){a.beginPath();a.moveTo(b[0].x,b[0].y);for(var f=1;f<b.length;f++)a.lineTo(b[f].x,b[f].y);a.lineWidth=d;a.strokeStyle=c;a.stroke()},rect:function(a,b,c,d,f,e,g,h){e&&(a.fillStyle=e,a.fillRect(b,c,d,f));h&&(a.strokeStyle=h,a.lineWidth=g,a.strokeRect(b,c,d,f))},drawYAxis:function(a,b,c,d,f,e,g,h,n,k,s,p,l,w,t,q){var m=s-p*(0-l)+q;b&&y.line(a,[{x:n,y:m},{x:k,y:m}],d,b);if(c)for(a.fillStyle=e,a.font=g+"px sans-serif",a.textAlign="right",
b=l;b<=w;b+=t)m=s-p*(b-l)+q,y.line(a,[{x:n,y:m},{x:k,y:m}],f,c),n&&(a.textBaseline=m>g/2?m>s-g/2?"bottom":"middle":"top",a.fillText(h(b)+"",n-2,m))},drawXAxis:function(a,b,c,d,f,e){a.fillStyle=b;a.font=c+"px sans-serif";a.textBaseline="top";a.textAlign="center";for(b=0;b<f.length;b++)for(var g=e[b].split(" "),h=0;h<g.length;h++)a.fillText(g[h],f[b].x,d+1+h*c)},tooltip:function(a,b,c,d,f,e,g,h){a.font=e+"px sans-serif";a.textAlign="left";a.textBaseline="top";var n=a.measureText("\u25a0").width;g=d.map(function(a){return(h(a)||
" ")+" "});var k=l.max.apply([],g.map(function(b){return a.measureText(b).width}));b-=6;c>d.length*e+6&&(c-=d.length*e);b<=k+n+7&&(b+=k+n+20+7);y.rect(a,b-k-n-4,c-3,k+n+7,d.length*e+8,"#fff",1,"#000");g.forEach(function(d,g){a.fillStyle=f[g%f.length];a.fillText("\u25a0",b-k-n-3,c+g*e);a.fillStyle="#000";a.fillText(d,b-k-2,c+g*e)})}};v.defaults={};v.graphers={};v.register=function(a,b,c){this.defaults[a]=b;this.graphers[a]=c};v.register("pie",{fill:["#f90","#ffd","#fc6"],line:{color:"#000",width:0},
focus:{color:"#000",width:0},delimiter:null,diameter:16,tooltip:r},function(a){var b=a.delimiter;b||(b=(b=this.$el.text().match(/[^0-9\.]/))?b[0]:",");var c=this.values.apply(this,[b]);"/"===b&&(c=[c[0],c[1]-c[0]]);var d,f=0,b=c.length;for(d=0;d<b;d++)f+=c[d];var e=this.$el.data("mouse"),g=a.focus,h=a.line,n=l.max(g.width,h.width)+1,k=a.diameter,k=this.prepareCanvas(k+n,k+n),s=this.context;d=k.width;var p=k.height,n=d/2-n,C=2*l.PI,f=C/f,w=this.fill();a=a.tooltip;if(g.width&&e){e=JSON.parse(e);e.x-=
d/2;e.y-=p/2;e.y*=-1;e.r=l.sqrt(e.x*e.x+e.y*e.y);for(e.a=l.atan2(e.y,e.x);0>e.a;)e.a+=C;for(;e.a>C;)e.a-=C}s.save();s.translate(d/2,p/2);var t,q=0;for(d=0;d<b;d++){p=c[d];t=p*f;y.circle(s,0,0,n,-q,-(q+t),w.call(this,p,d,c));if(g.width&&e&&e.a>q&&e.a<q+t&&e.r<n){y.arc(s,0,0,n+g.width/2,-q,-(q+t),g.color,g.width);var m=d}q+=t}h.width&&y.arc(s,0,0,n+h.width/2,0,C,h.color,h.width);g.width&&(e&&void 0!==m&&(e=JSON.parse(this.$el.data("mouse")),s.restore(),y.tooltip(s,e.x,e.y,[c[m]],[w.call(this,c[m],m,
c)],a.size,a.color,a.formatter)),H(k))});v.register("lines",{lineColors:["#78A","#827"],lineWidths:[1],fill:"#cdf",delimiters:["|",","],height:32,width:32,left:0,max:null,min:0,pointSizes:[2],xAxis:r,yAxis:r,focus:!1,tooltip:r,gridlines:{widths:[1,0],colors:["#000","#bbb"]}},function(a){var b=this.$el.data("mouse"),c=this.values.apply(this,a.delimiters),d,f=a.pointSizes,e=a.xAxis,g=a.yAxis,h=a.focus,n=a.tooltip,k=a.gridlines,s=[].concat.apply([a.max,a.min],c),p=a.labels;p&&(p=p.map(function(a){return a+
""}));var C=0;p&&(C=l.max.apply(this,p.map(function(a){return a.replace(/[^ ]/g,"").length}))+1);var w=l.max.apply(l,s),t=l.min.apply(l,s),q=a.region||(w-t)/5,w=l.ceil(w/q)*q,t=l.floor(t/q)*q,s=this.prepareCanvas(a.width,a.height),m=this.context,r=a.left,E=C*e.size+(C?4:0),x=s.width,A=x-2*l.max.apply(l,f)-r,E=s.height-E,A=A/(c[0].length-0.5),G=E/(w-t),v=a.lineColors,D=a.lineWidths,k=a.gridlines,u,z,I,B,F=[];for(z=0;z<c.length;z+=1){I=c[z];B=[];for(u=0;u<I.length;u++)d=I[u],B.push({x:u*A+f[z%f.length]+
r+A/4,y:E-G*(d-t)});if(a.fill&&1===c.length){m.beginPath();d=0;m.moveTo(r+A/4+f[0],E-G*(d-t));for(u=0;u<B.length;u++)m.lineTo(B[u].x,B[u].y);d=0;m.lineTo(x-f[0]-A/4,E-G*(d-t));m.fillStyle=a.fill;m.fill()}F.push(B)}y.drawYAxis(m,k.widths[0],k.widths[1],k.colors[0],k.colors[1],g.color,g.size,g.formatter,r,x,E,G,t,w,q,0);for(z=0;z<c.length;z+=1){B=F[z];for(u=0;u<B.length;u++)y.circle(m,B[u].x,B[u].y,f[z%f.length],0,2*l.PI,v[z%v.length]);y.line(m,B,v[z%v.length],D[z%D.length])}C&&y.drawXAxis(m,e.color,
e.size,E,F[0],p);if(h&&b)for(b=JSON.parse(b),u=0;u<F[0].length;u++)if(a=F[0][u],b.x>=a.x-A/3&&b.x<=a.x+A/3){y.tooltip(m,b.x,b.y,c.map(function(a){return a[u]}),v,n.size,n.color,n.formatter);break}h&&H(s)});v.register("bar",{fill:["#48f"],delimiter:",",height:16,width:32,left:0,gap:1,max:null,min:0,xAxis:r,yAxis:r,focus:{color:"#000",width:0},tooltip:r,gridlines:{widths:[1,0],colors:["#000","#bbb"]}},function(a){var b,c,d=this.values.apply(this,[a.delimiter]),f=a.labels;f&&(f=f.map(function(a){return a+
""}));var e=0;f&&(e=l.max.apply(this,f.map(function(a){return a.replace(/[^ ]/g,"").length}))+1);b=l.max.apply(l,d.concat([a.max]));var g=l.min.apply(l,d.concat([a.min]));c=a.region||(b-g)/5;b=l.ceil(b/c)*c;var g=l.floor(g/c)*c,h=this.$el.data("mouse"),n=this.prepareCanvas(a.width,a.height),k=this.context,s=this.fill(),p=a.yAxis,r=a.xAxis,w=a.focus,t=a.tooltip,q=a.gridlines,m=n.width,v=a.gap;a=a.left;var x=n.height-(e*r.size+(e?4:0))-q.widths[0],D=x/(b-g),A=(m-2*v-a+v)/d.length;y.drawYAxis(k,q.widths[0],
q.widths[1],q.colors[0],q.colors[1],p.color,p.size,p.formatter,a,m,x,D,g,b,c,0);p=[];for(b=0;b<d.length;b++)c=d[b],p.push([a+b*A+v,x-D*(c-g),A-v,0===c?1:D*c]),k.fillStyle=s.call(this,c,b,d),k.fillRect.apply(k,p[b]);e&&y.drawXAxis(k,r.color,r.size,x,p.map(function(a){return{x:a[0]+a[2]/2}}),f);if(w.width&&h)for(h=JSON.parse(h),b=0;b<p.length;b++)if(f=p[b],h.x>=f[0]&&h.x<=f[0]+f[2]){f[1]+=l.min(f[3],0);f[3]=l.abs(f[3]);h.y>=f[1]&&h.y<=f[1]+f[3]&&(c=d[b],y.rect(k,f[0]-w.width/2,f[1]-w.width/2,f[2]+w.width,
f[3]+w.width,void 0,w.width,w.color),y.tooltip(k,h.x,h.y,[d[b]],[s.call(this,c,b,d)],t.size,t.color,t.formatter));break}w.width&&H(n)})})(jQuery,Math);
