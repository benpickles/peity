(function(h,y,t){var z=y.createElement("canvas").getContext,n=h.fn.peity=function(a,d){z&&this.each(function(){var c=h(this),e=c.data("peity");if(e)a&&(e.type=a),h.extend(e.opts,d),e.draw();else{var k=n.defaults[a],b={};h.each(c.data(),function(a,c){a in k&&(b[a]=c)});var f=h.extend({},k,b,d),e=new x(c,a,f);e.draw();c.change(function(a,c,b){e.draw()}).data("peity",e)}});return this},x=function(a,d,c){this.$el=a;this.type=d;this.opts=c},s=x.prototype;s.colors=function(){var a=this.opts.colors;return h.isFunction(a)?
a:function(d,c){return a[c%a.length]}};s.draw=function(){n.graphers[this.type].call(this,this.opts)};s.prepareCanvas=function(a,d){var c=this.canvas,e;c?(this.context.clearRect(0,0,c.width,c.height),e=h(c)):(e=h("<canvas>").css({height:d,width:a}).addClass("peity").data("peity",this),this.canvas=c=e[0],this.context=c.getContext("2d"),this.$el.hide().after(c));c.height=e.height()*t;c.width=e.width()*t;return c};s.hoverEvent=function(a){this.removeEventListener("mouseout",this.exitEvent,!1);this.removeEventListener("mousemove",
this.hoverEvent,!1);var d=this.getBoundingClientRect();a={x:a.clientX-d.left,y:a.clientY-d.top};h(this.previousSibling).data("position",JSON.stringify(a)).change()};s.exitEvent=function(a){this.removeEventListener("mouseout",this.exitEvent,!1);this.removeEventListener("mousemove",this.hoverEvent,!1);h(this.previousSibling).removeData("position").change()};s.addEvents=function(){var a=this.canvas;a.addEventListener("mousemove",s.hoverEvent,!1);a.addEventListener("mouseout",s.exitEvent,!1);return this};
s.values=function(){var a=this.opts.delimiter;return this.opts.seriesDelimiter?this.$el.text().split(this.opts.seriesDelimiter).map(function(d){return d.split(a).map(function(a){return parseFloat(a)})}):this.$el.text().split(this.opts.delimiter).map(function(a){return parseFloat(a)})};s.drawArc=function(a,d,c,e,k,b,f){a.beginPath();a.arc(0,0,d,c,e,k);a.strokeStyle=b;a.lineWidth=f;a.stroke()};n.defaults={};n.graphers={};n.register=function(a,d,c){this.defaults[a]=d;this.graphers[a]=c};n.register("pie",
{colors:["#f90","#ffd","#fc6"],delimiter:null,diameter:16,lineColor:"#000",lineWidth:0,focusColor:"#000",focusWidth:0},function(a){if(!a.delimiter){var d=this.$el.text().match(/[^0-9\.]/);a.delimiter=d?d[0]:","}d=this.values();"/"===a.delimiter&&(d=[d[0],d[1]-d[0]]);var c,e=0,k=d.length;for(c=0;c<k;c++)e+=d[c];var b=this.$el.data("position"),f=a.focusWidth,w=a.lineWidth,m=Math.max(f,w)+1,l=this.prepareCanvas(a.diameter+m,a.diameter+m),g=this.context;c=l.width;var q=l.height,m=c/2-m,l=2*Math.PI,e=
l/e,r=this.colors();if(0<f&&void 0!==b){b=JSON.parse(b);b.x-=c/2;b.y-=q/2;b.y*=-1;b.r=Math.sqrt(b.x*b.x+b.y*b.y);for(b.theta=Math.atan2(b.y,b.x);0>b.theta;)b.theta+=l;for(;b.theta>l;)b.theta-=l}g.translate(c/2,q/2);var p,h=0;for(c=0;c<k;c++)q=d[c],p=q*e,g.beginPath(),g.moveTo(0,0),g.arc(0,0,m,-h,-(h+p),!0),g.fillStyle=r.call(this,q,c,d),g.fill(),0<f&&b&&b.theta>h&&b.theta<h+p&&this.drawArc(g,m+f/2,-h,-(h+p),!0,a.focusColor,f),h+=p;0<w&&this.drawArc(g,m+w/2,0,l,!0,a.lineColor,w);0<f&&this.addEvents()});
n.register("line",{color:"#cdf",lineColor:"#48f",lineWidth:1,delimiter:",",height:16,width:32,max:null,min:0,fill:!0},function(a){var d=this.values();1==d.length&&d.push(d[0]);var c=Math.max.apply(Math,d.concat([a.max])),e=Math.min.apply(Math,d.concat([a.min])),k=this.prepareCanvas(a.width,a.height),b=this.context,f=k.width,k=k.height,h=f/(d.length-1),c=k/(c-e),m=[],l;b.beginPath();b.moveTo(0,k+e*c);for(l=0;l<d.length;l++){var g=l*h,q=k-c*(d[l]-e);m.push({x:g,y:q});b.lineTo(g,q)}b.lineTo(f,k+e*c);
a.fill&&(b.fillStyle=a.color,b.fill());if(a.lineWidth){b.beginPath();b.moveTo(0,m[0].y);for(l=0;l<m.length;l++)b.lineTo(m[l].x,m[l].y);b.lineWidth=a.lineWidth*t;b.strokeStyle=a.lineColor;b.stroke()}});n.register("multiline",{colors:["#666666","#803E75","#FF6800"],lineColor:"#4d89f9",lineWidth:1,delimiter:",",seriesDelimiter:"|",height:16,max:null,min:0,width:32},function(a){var d=this.values(),c=[].concat.apply([],d);console.log(c);var e=Math.max.apply(Math,c.concat([a.max])),c=Math.min.apply(Math,
c.concat([a.min])),k=this.prepareCanvas(a.width,a.height),b=this.context,f=k.width,k=k.height,h=f/(d[1].length-1),e=k/(e-c),m,l,g;b.lineWidth=a.lineWidth*t;g=[{x:0,y:k-e*(0-c)},{x:f,y:k-e*(0-c)}];b.beginPath();b.moveTo(0,g[0].y);for(f=0;f<g.length;f++)b.lineTo(g[f].x,g[f].y);b.strokeStyle=a.colors[0%a.colors.length];b.stroke();for(m=0;m<d.length;m+=1){l=d[m];g=[];for(f=0;f<l.length;f++)g.push({x:f*h,y:k-e*(l[f]-c)});b.beginPath();b.moveTo(0,g[0].y);for(f=0;f<g.length;f++)b.lineTo(g[f].x,g[f].y);b.strokeStyle=
a.colors[(m+1)%a.colors.length];b.stroke()}});n.register("bar",{colors:["#48f"],baselineColour:"#000",baselineHeight:1,fontColour:"#000",fontStyle:"12pt Arial, sans-serif",focusColor:"#000",focusWidth:0,height:16,width:32,max:null,min:0,delimiter:",",spacing:1},function(a){var d,c,e,k,b,f,h=this.values(),m=Math.max.apply(Math,h.concat([a.max])),l=Math.min.apply(Math,h.concat([a.min])),g=this.$el.data("position"),q=this.prepareCanvas(a.width,a.height),r=this.context,p=a.spacing,s=this.colors(),n=a.focusWidth;
d=q.width-2*p;var u=q.height-2*p;a.baselineHeight&&(u-=1);var v=u/(m-l),t=(d+p)/h.length;r.fillStyle=a.baselineColour;r.fillRect(0,v*m+p-a.baselineHeight/2,q.width,a.baselineHeight);for(d=0;d<h.length;d++){c=p+d*t;b=t-p;f=h[d];e=p+u-v*(f-l);if(0===f){if(0<=l||0<m)e-=1;k=1}else k=v*h[d];f=s.call(this,f,d,h);void 0!==f&&(r.fillStyle=f);r.fillRect(c,e,b,k)}if(0<n&&g)for(g=JSON.parse(g),d=0;d<h.length;d++)if(c=p+d*t,b=t-p,g.x>=c&&g.x<=c+b){f=h[d];e=p+u-v*(f-l);if(0===f){if(0<=l||0<m)e-=1;k=1}else k=v*
h[d];e+=Math.min(k,0);k=Math.abs(k);g.y>=e&&g.y<=e+k&&(r.strokeStyle=a.focusColor,r.lineWidth=n,r.strokeRect(c-n/2,e-n/2,b+n,k+n),r.fillStyle=a.fontColour,r.font=a.fontStyle,g.x>q.width/2&&(r.textAlign="right"),g.y<q.height/2&&(r.textBaseline="top",g.y+=20),r.fillText(f+"",g.x,g.y))}0<n&&this.addEvents()})})(jQuery,document,window.devicePixelRatio||1);
