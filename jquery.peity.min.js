// Peity jQuery plugin version 1.2.1
// (c) 2013 Ben Pickles
//
// http://benpickles.github.io/peity
//
// Released under MIT license.
(function(v,n){var K=document.createElement("canvas").getContext,t=v.fn.peity=function(a,b){K&&this.each(function(){var c=v(this),e=c.data("peity");if(e)a&&(e.type=a),v.extend(!0,e.opt,b),e.draw();else{var d=t.defaults[a],f={};v.each(c.data(),function(a,b){a in d&&(f[a]=b)});var h=v.extend(!0,{},d,f,b),e=new E(c,a,h);e.draw();c.change(function(a,b,c){e.draw()}).data("peity",e)}});return this},E=function(a,b,c){this.$el=a;this.type=b;this.opt=c},r=E.prototype;r.fill=function(){var a=this.opt.fill;
return v.isFunction(a)?a:function(b,c){return a[c%a.length]}};r.draw=function(){t.graphers[this.type].call(this,this.opt)};r.prepareCanvas=function(a,b){var c=this.canvas;if(c)c.width=c.width;else{var e=v("<canvas>").css({height:b,width:a}).addClass("peity").data("peity",this);this.canvas=c=e[0];this.context=c.getContext("2d");this.$el.hide().after(c);c.height=e.height();c.width=e.width()}return c};r.values=function(){var a=function(a){return parseFloat(a)},b=arguments,c=this.$el.text().split(b[0]);
return 1===b.length?c.map(a):c.map(function(c){return c.split(b[1]).map(a)})};var r={color:"#000",size:13,formatter:function(a){return a}},J=function(a){var b=this.getBoundingClientRect();v(this).off().prev().data("mouse",JSON.stringify({x:a.clientX-b.left,y:a.clientY-b.top})).change()},H=function(a){v(a).on("mousemove",J).on("mouseout",J)},B={arc:function(a,b,c,e,d,f,h,l){a.beginPath();a.arc(b,c,e,d,f,!0);a.lineWidth=l;a.strokeStyle=h;a.stroke()},circle:function(a,b,c,e,d,f,h){a.beginPath();a.moveTo(b,
c);a.arc(b,c,e,d,f,!0);a.fillStyle=h;a.fill()},line:function(a,b,c,e){a.beginPath();a.moveTo(b[0].x,b[0].y);for(var d=1;d<b.length;d++)a.lineTo(b[d].x,b[d].y);a.lineWidth=e;a.strokeStyle=c;a.stroke()},drawYAxis:function(a,b,c,e,d,f,h,l,g,n,k,u,x,q,p,y){var m=k-u*(0-x)+y;b&&B.line(a,[{x:g,y:m},{x:n,y:m}],e,b);if(c)for(a.fillStyle=f,a.font=h+"px sans-serif",a.textAlign="right",b=x;b<=q;b+=p)m=k-u*(b-x)+y,B.line(a,[{x:g,y:m},{x:n,y:m}],d,c),g&&(a.textBaseline=m>h/2?m>k-h/2?"bottom":"middle":"top",a.fillText(l(b)+
"",g-2,m))},drawXAxis:function(a,b,c,e,d,f){a.fillStyle=b;a.font=c+"px sans-serif";a.textBaseline="top";a.textAlign="center";for(b=0;b<d.length;b++)for(var h=f[b].split(" "),l=0;l<h.length;l++)a.fillText(h[l],d[b].x,e+1+l*c)}};t.defaults={};t.graphers={};t.register=function(a,b,c){this.defaults[a]=b;this.graphers[a]=c};t.register("pie",{fill:["#f90","#ffd","#fc6"],line:{color:"#000",width:0},focus:{color:"#000",width:0},delimiter:null,diameter:16},function(a){var b=a.delimiter;b||(b=(b=this.$el.text().match(/[^0-9\.]/))?
b[0]:",");var c=this.values.apply(this,[b]);"/"===b&&(c=[c[0],c[1]-c[0]]);var e,d=0,b=c.length;for(e=0;e<b;e++)d+=c[e];var f=this.$el.data("mouse"),h=a.focus,l=a.line,g=n.max(h.width,l.width)+1;a=a.diameter;a=this.prepareCanvas(a+g,a+g);var D=this.context;e=a.width;var k=a.height,g=e/2-g,u=2*n.PI,d=u/d,x=this.fill();if(h.width&&f){f=JSON.parse(f);f.x-=e/2;f.y-=k/2;f.y*=-1;f.r=n.sqrt(f.x*f.x+f.y*f.y);for(f.a=n.atan2(f.y,f.x);0>f.a;)f.a+=u;for(;f.a>u;)f.a-=u}D.translate(e/2,k/2);var q,p=0;for(e=0;e<
b;e++)k=c[e],q=k*d,B.circle(D,0,0,g,-p,-(p+q),x.call(this,k,e,c)),h.width&&f&&f.a>p&&f.a<p+q&&B.arc(D,0,0,g+h.width/2,-p,-(p+q),h.color,h.width),p+=q;l.width&&B.arc(D,0,0,g+l.width/2,0,u,l.color,l.width);h.width&&H(a)});t.register("lines",{lineColors:["#78A","#827"],lineWidths:[1],fill:"#cdf",delimiters:["|",","],height:32,width:32,left:0,max:null,min:0,pointSizes:[2],xAxis:r,yAxis:r,focus:!1,tooltip:r,gridlines:{widths:[1,0],colors:["#000","#bbb"]}},function(a){var b=this.$el.data("mouse"),c=this.values.apply(this,
a.delimiters),e,d=a.pointSizes,f=a.xAxis,h=a.yAxis,l=a.focus,g=a.tooltip,D=a.gridlines,k=[].concat.apply([a.max,a.min],c),u=a.labels;u&&(u=u.map(function(a){return a+""}));var x=0;u&&(x=n.max.apply(this,u.map(function(a){return a.replace(/[^ ]/g,"").length}))+1);var q=n.max.apply(n,k),p=n.min.apply(n,k),y=a.region||(q-p)/5,q=n.ceil(q/y)*y,p=n.floor(p/y)*y,k=this.prepareCanvas(a.width,a.height),m=this.context,r=a.left,z=x*f.size+(x?4:0),v=k.width,A=v-2*n.max.apply(n,d)-r,z=k.height-z,A=A/(c[0].length-
0.5),t=z/(q-p),F=a.lineColors,E=a.lineWidths,D=a.gridlines,s,w,I,C,G=[];for(w=0;w<c.length;w+=1){I=c[w];C=[];for(s=0;s<I.length;s++)e=I[s],C.push({x:s*A+d[w%d.length]+r+A/4,y:z-t*(e-p)});if(a.fill&&1===c.length){m.beginPath();e=0;m.moveTo(r+A/4+d[0],z-t*(e-p));for(s=0;s<C.length;s++)m.lineTo(C[s].x,C[s].y);e=0;m.lineTo(v-d[0]-A/4,z-t*(e-p));m.fillStyle=a.fill;m.fill()}G.push(C)}B.drawYAxis(m,D.widths[0],D.widths[1],D.colors[0],D.colors[1],h.color,h.size,h.formatter,r,v,z,t,p,q,y,0);for(w=0;w<c.length;w+=
1){C=G[w];for(s=0;s<C.length;s++)B.circle(m,C[s].x,C[s].y,d[w%d.length],0,2*n.PI,F[w%F.length]);B.line(m,C,F[w%F.length],E[w%E.length])}x&&B.drawXAxis(m,f.color,f.size,z,G[0],u);if(l&&b)for(b=JSON.parse(b),s=0;s<G[0].length;s++)if(a=G[0][s],b.x>=a.x-A/3&&b.x<=a.x+A/3){m.font=g.size+"px sans-serif";m.textAlign="right";b.y<z/2?(m.textBaseline="top",b.y+=g.size):(m.textBaseline="bottom",b.y-=g.size);c.forEach(function(a,c){m.fillStyle=F[c%F.length];m.fillText((g.formatter(a[s])||" ")+" \u25a0",b.x,b.y+
c*g.size)});break}l&&H(k)});t.register("bar",{fill:["#48f"],delimiter:",",height:16,width:32,left:0,gap:1,max:null,min:0,xAxis:r,yAxis:r,focus:{color:"#000",width:0},tooltip:r,gridlines:{widths:[1,0],colors:["#000","#bbb"]}},function(a){var b,c,e=this.values.apply(this,[a.delimiter]),d=a.labels;d&&(d=d.map(function(a){return a+""}));var f=0;d&&(f=n.max.apply(this,d.map(function(a){return a.replace(/[^ ]/g,"").length}))+1);b=n.max.apply(n,e.concat([a.max]));var h=n.min.apply(n,e.concat([a.min])),l=
a.region||(b-h)/5;b=n.ceil(b/l)*l;var h=n.floor(h/l)*l,g=this.$el.data("mouse"),r=this.prepareCanvas(a.width,a.height),k=this.context,u=this.fill();c=a.yAxis;var x=a.xAxis,q=a.focus,p=a.tooltip,y=a.gridlines,m=r.width,v=r.height,z=a.gap;a=a.left;var t=v-(f*x.size+(f?4:0))-y.widths[0],A=t/(b-h),E=(m-2*z-a+z)/e.length;B.drawYAxis(k,y.widths[0],y.widths[1],y.colors[0],y.colors[1],c.color,c.size,c.formatter,a,m,t,A,h,b,l,0);l=[];for(b=0;b<e.length;b++)c=e[b],l.push([a+b*E+z,t-A*(c-h),E-z,0===c?1:A*c]),
k.fillStyle=u.call(this,c,b,e),k.fillRect.apply(k,l[b]);f&&B.drawXAxis(k,x.color,x.size,t,l.map(function(a){return{x:a[0]+a[2]/2}}),d);if(q.width&&g)for(g=JSON.parse(g),b=0;b<l.length;b++)if(d=l[b],g.x>=d[0]&&g.x<=d[0]+d[2]){d[1]+=n.min(d[3],0);d[3]=n.abs(d[3]);g.y>=d[1]&&g.y<=d[1]+d[3]&&(k.lineWidth=q.width,k.strokeStyle=q.color,k.strokeRect(d[0]-q.width/2,d[1]-q.width/2,d[2]+q.width,d[3]+q.width),k.fillStyle=p.color,k.font=p.size+"px sans-serif",g.x>m/2&&(k.textAlign="right"),g.y<v/2?(k.textBaseline=
"top",g.y+=20):k.textBaseline="bottom",k.fillText(p.formatter(e[b])+"",g.x,g.y));break}q.width&&H(r)})})(jQuery,Math);
