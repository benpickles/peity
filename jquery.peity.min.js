// Peity jQuery plugin version 1.2.1
// (c) 2013 Ben Pickles
//
// http://benpickles.github.io/peity
//
// Released under MIT license.
(function(v,n){var K=document.createElement("canvas").getContext,t=v.fn.peity=function(a,b){K&&this.each(function(){var c=v(this),e=c.data("peity");if(e)a&&(e.type=a),v.extend(!0,e.opt,b),e.draw();else{var d=t.defaults[a],f={};v.each(c.data(),function(a,b){a in d&&(f[a]=b)});var h=v.extend(!0,{},d,f,b),e=new C(c,a,h);e.draw();c.change(function(a,b,c){e.draw()}).data("peity",e)}});return this},C=function(a,b,c){this.$el=a;this.type=b;this.opt=c},r=C.prototype;r.fill=function(){var a=this.opt.fill;
return v.isFunction(a)?a:function(b,c){return a[c%a.length]}};r.draw=function(){t.graphers[this.type].call(this,this.opt)};r.prepareCanvas=function(a,b){var c=this.canvas;if(c)c.width=c.width;else{var e=v("<canvas>").css({height:b,width:a}).addClass("peity").data("peity",this);this.canvas=c=e[0];this.context=c.getContext("2d");this.$el.hide().after(c);c.height=e.height();c.width=e.width()}return c};r.values=function(){var a=function(a){return parseFloat(a)},b=arguments,c=this.$el.text().split(b[0]);
return 1===b.length?c.map(a):c.map(function(c){return c.split(b[1]).map(a)})};var r={color:"#000",size:13,formatter:function(a){return a}},G=function(a){var b=this.getBoundingClientRect();v(this).off().prev().data("mouse",JSON.stringify({x:a.clientX-b.left,y:a.clientY-b.top})).change()},I=function(a){v(a).on("mousemove",G).on("mouseout",G)},z={arc:function(a,b,c,e,d,f,h,k){a.beginPath();a.arc(b,c,e,d,f,!0);a.lineWidth=k;a.strokeStyle=h;a.stroke()},circle:function(a,b,c,e,d,f,h){a.beginPath();a.moveTo(b,
c);a.arc(b,c,e,d,f,!0);a.fillStyle=h;a.fill()},line:function(a,b,c,e){a.beginPath();a.moveTo(b[0].x,b[0].y);for(var d=1;d<b.length;d++)a.lineTo(b[d].x,b[d].y);a.lineWidth=e;a.strokeStyle=c;a.stroke()},rect:function(a,b,c,e,d,f,h,k){f&&(a.fillStyle=f,a.fillRect(b,c,e,d));k&&(a.strokeStyle=k,a.lineWidth=h,a.strokeRect(b,c,e,d))},drawYAxis:function(a,b,c,e,d,f,h,k,g,n,m,u,x,q,p,y){var l=m-u*(0-x)+y;b&&z.line(a,[{x:g,y:l},{x:n,y:l}],e,b);if(c)for(a.fillStyle=f,a.font=h+"px sans-serif",a.textAlign="right",
b=x;b<=q;b+=p)l=m-u*(b-x)+y,z.line(a,[{x:g,y:l},{x:n,y:l}],d,c),g&&(a.textBaseline=l>h/2?l>m-h/2?"bottom":"middle":"top",a.fillText(k(b)+"",g-2,l))},drawXAxis:function(a,b,c,e,d,f){a.fillStyle=b;a.font=c+"px sans-serif";a.textBaseline="top";a.textAlign="center";for(b=0;b<d.length;b++)for(var h=f[b].split(" "),k=0;k<h.length;k++)a.fillText(h[k],d[b].x,e+1+k*c)}};t.defaults={};t.graphers={};t.register=function(a,b,c){this.defaults[a]=b;this.graphers[a]=c};t.register("pie",{fill:["#f90","#ffd","#fc6"],
line:{color:"#000",width:0},focus:{color:"#000",width:0},delimiter:null,diameter:16},function(a){var b=a.delimiter;b||(b=(b=this.$el.text().match(/[^0-9\.]/))?b[0]:",");var c=this.values.apply(this,[b]);"/"===b&&(c=[c[0],c[1]-c[0]]);var e,d=0,b=c.length;for(e=0;e<b;e++)d+=c[e];var f=this.$el.data("mouse"),h=a.focus,k=a.line,g=n.max(h.width,k.width)+1;a=a.diameter;a=this.prepareCanvas(a+g,a+g);var D=this.context;e=a.width;var m=a.height,g=e/2-g,u=2*n.PI,d=u/d,x=this.fill();if(h.width&&f){f=JSON.parse(f);
f.x-=e/2;f.y-=m/2;f.y*=-1;f.r=n.sqrt(f.x*f.x+f.y*f.y);for(f.a=n.atan2(f.y,f.x);0>f.a;)f.a+=u;for(;f.a>u;)f.a-=u}D.translate(e/2,m/2);var q,p=0;for(e=0;e<b;e++)m=c[e],q=m*d,z.circle(D,0,0,g,-p,-(p+q),x.call(this,m,e,c)),h.width&&f&&f.a>p&&f.a<p+q&&z.arc(D,0,0,g+h.width/2,-p,-(p+q),h.color,h.width),p+=q;k.width&&z.arc(D,0,0,g+k.width/2,0,u,k.color,k.width);h.width&&I(a)});t.register("lines",{lineColors:["#78A","#827"],lineWidths:[1],fill:"#cdf",delimiters:["|",","],height:32,width:32,left:0,max:null,
min:0,pointSizes:[2],xAxis:r,yAxis:r,focus:!1,tooltip:r,gridlines:{widths:[1,0],colors:["#000","#bbb"]}},function(a){var b=this.$el.data("mouse"),c=this.values.apply(this,a.delimiters),e,d=a.pointSizes,f=a.xAxis,h=a.yAxis,k=a.focus,g=a.tooltip,D=a.gridlines,m=[].concat.apply([a.max,a.min],c),u=a.labels;u&&(u=u.map(function(a){return a+""}));var x=0;u&&(x=n.max.apply(this,u.map(function(a){return a.replace(/[^ ]/g,"").length}))+1);var q=n.max.apply(n,m),p=n.min.apply(n,m),y=a.region||(q-p)/5,q=n.ceil(q/
y)*y,p=n.floor(p/y)*y,m=this.prepareCanvas(a.width,a.height),l=this.context,r=a.left,E=x*f.size+(x?4:0),v=m.width,A=v-2*n.max.apply(n,d)-r,E=m.height-E,A=A/(c[0].length-0.5),t=E/(q-p),F=a.lineColors,C=a.lineWidths,D=a.gridlines,s,w,J,B,H=[];for(w=0;w<c.length;w+=1){J=c[w];B=[];for(s=0;s<J.length;s++)e=J[s],B.push({x:s*A+d[w%d.length]+r+A/4,y:E-t*(e-p)});if(a.fill&&1===c.length){l.beginPath();e=0;l.moveTo(r+A/4+d[0],E-t*(e-p));for(s=0;s<B.length;s++)l.lineTo(B[s].x,B[s].y);e=0;l.lineTo(v-d[0]-A/4,
E-t*(e-p));l.fillStyle=a.fill;l.fill()}H.push(B)}z.drawYAxis(l,D.widths[0],D.widths[1],D.colors[0],D.colors[1],h.color,h.size,h.formatter,r,v,E,t,p,q,y,0);for(w=0;w<c.length;w+=1){B=H[w];for(s=0;s<B.length;s++)z.circle(l,B[s].x,B[s].y,d[w%d.length],0,2*n.PI,F[w%F.length]);z.line(l,B,F[w%F.length],C[w%C.length])}x&&z.drawXAxis(l,f.color,f.size,E,H[0],u);if(k&&b)for(b=JSON.parse(b),s=0;s<H[0].length;s++)if(a=H[0][s],b.x>=a.x-A/3&&b.x<=a.x+A/3){l.font=g.size+"px sans-serif";l.textAlign="right";l.textBaseline=
"top";l.fillStyle="#fff";l.strokeStyle="#000";b.x-=2;b.y>c.length*g.size&&(b.y-=c.length*g.size);a=c.map(function(a){return(g.formatter(a[s])||" ")+" \u25a0"});d=n.max.apply([],a.map(function(a){return l.measureText(a).width}));b.x<=d+2&&(b.x+=d+20);z.rect(l,b.x-d-1,b.y-1,d+2,c.length*g.size+4,"#fff",1,"#000");a.forEach(function(a,c){l.fillStyle=F[c%F.length];l.fillText(a,b.x,b.y+c*g.size)});break}k&&I(m)});t.register("bar",{fill:["#48f"],delimiter:",",height:16,width:32,left:0,gap:1,max:null,min:0,
xAxis:r,yAxis:r,focus:{color:"#000",width:0},tooltip:r,gridlines:{widths:[1,0],colors:["#000","#bbb"]}},function(a){var b,c,e=this.values.apply(this,[a.delimiter]),d=a.labels;d&&(d=d.map(function(a){return a+""}));var f=0;d&&(f=n.max.apply(this,d.map(function(a){return a.replace(/[^ ]/g,"").length}))+1);b=n.max.apply(n,e.concat([a.max]));var h=n.min.apply(n,e.concat([a.min])),k=a.region||(b-h)/5;b=n.ceil(b/k)*k;var h=n.floor(h/k)*k,g=this.$el.data("mouse"),r=this.prepareCanvas(a.width,a.height),m=
this.context,u=this.fill();c=a.yAxis;var x=a.xAxis,q=a.focus,p=a.tooltip,y=a.gridlines,l=r.width,v=r.height,t=a.gap;a=a.left;var C=v-(f*x.size+(f?4:0))-y.widths[0],A=C/(b-h),G=(l-2*t-a+t)/e.length;z.drawYAxis(m,y.widths[0],y.widths[1],y.colors[0],y.colors[1],c.color,c.size,c.formatter,a,l,C,A,h,b,k,0);k=[];for(b=0;b<e.length;b++)c=e[b],k.push([a+b*G+t,C-A*(c-h),G-t,0===c?1:A*c]),m.fillStyle=u.call(this,c,b,e),m.fillRect.apply(m,k[b]);f&&z.drawXAxis(m,x.color,x.size,C,k.map(function(a){return{x:a[0]+
a[2]/2}}),d);if(q.width&&g)for(g=JSON.parse(g),b=0;b<k.length;b++)if(d=k[b],g.x>=d[0]&&g.x<=d[0]+d[2]){d[1]+=n.min(d[3],0);d[3]=n.abs(d[3]);g.y>=d[1]&&g.y<=d[1]+d[3]&&(z.rect(m,d[0]-q.width/2,d[1]-q.width/2,d[2]+q.width,d[3]+q.width,void 0,q.width,q.color),m.fillStyle=p.color,m.font=p.size+"px sans-serif",m.textBaseline="top",m.textAlign="right",c=p.formatter(e[b])+"",d=m.measureText(c).width,g.x<d&&(g.x+=d+20),g.y>v-p.size&&(g.y-=p.size+1),m.fillText(p.formatter(e[b])+"",g.x,g.y));break}q.width&&
I(r)})})(jQuery,Math);
