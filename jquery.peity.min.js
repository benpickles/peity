(function(g,z,t){var A=z.createElement("canvas").getContext,n=g.fn.peity=function(a,b){A&&this.each(function(){var d=g(this),e=d.data("peity");if(e)a&&(e.type=a),g.extend(e.opts,b),e.draw();else{var h=n.defaults[a],c={};g.each(d.data(),function(a,b){a in h&&(c[a]=b)});var k=g.extend({},h,c,b),e=new y(d,a,k);e.draw();d.change(function(a,b,c){e.draw()}).data("peity",e)}});return this},y=function(a,b,d){this.$el=a;this.type=b;this.opts=d},s=y.prototype;s.colors=function(){var a=this.opts.colors;return g.isFunction(a)?
a:function(b,d){return a[d%a.length]}};s.draw=function(){n.graphers[this.type].call(this,this.opts)};s.prepareCanvas=function(a,b){var d=this.canvas,e;d?(this.context.clearRect(0,0,d.width,d.height),e=g(d)):(e=g("<canvas>").css({height:b,width:a}).addClass("peity").data("peity",this),this.canvas=d=e[0],this.context=d.getContext("2d"),this.$el.hide().after(d));d.height=e.height()*t;d.width=e.width()*t;return d};s.hoverEvent=function(a){this.removeEventListener("mouseout",this.exitEvent,!1);this.removeEventListener("mousemove",
this.hoverEvent,!1);var b=this.getBoundingClientRect();a={x:a.clientX-b.left,y:a.clientY-b.top};g(this.previousSibling).data("position",JSON.stringify(a)).change()};s.exitEvent=function(a){this.removeEventListener("mouseout",this.exitEvent,!1);this.removeEventListener("mousemove",this.hoverEvent,!1);g(this.previousSibling).removeData("position").change()};s.addEvents=function(){var a=this.canvas;a.addEventListener("mousemove",s.hoverEvent,!1);a.addEventListener("mouseout",s.exitEvent,!1);return this};
s.values=function(){var a=this.opts.delimiter;return this.opts.seriesDelimiter?this.$el.text().split(this.opts.seriesDelimiter).map(function(b){return b.split(a).map(function(a){return parseFloat(a)})}):this.$el.text().split(this.opts.delimiter).map(function(a){return parseFloat(a)})};s.drawArc=function(a,b,d,e,h,c,k){a.beginPath();a.arc(0,0,b,d,e,h);a.strokeStyle=c;a.lineWidth=k;a.stroke()};n.defaults={};n.graphers={};n.register=function(a,b,d){this.defaults[a]=b;this.graphers[a]=d};n.register("pie",
{colors:["#f90","#ffd","#fc6"],delimiter:null,diameter:16,lineColor:"#000",lineWidth:0,focusColor:"#000",focusWidth:0},function(a){if(!a.delimiter){var b=this.$el.text().match(/[^0-9\.]/);a.delimiter=b?b[0]:","}b=this.values();"/"===a.delimiter&&(b=[b[0],b[1]-b[0]]);var d,e=0,h=b.length;for(d=0;d<h;d++)e+=b[d];var c=this.$el.data("position"),k=a.focusWidth,w=a.lineWidth,m=Math.max(k,w)+1,l=a.diameter,f=this.prepareCanvas(l+m,l+m),l=this.context;d=f.width;var q=f.height,m=d/2-m,f=2*Math.PI,e=f/e,r=
this.colors();if(0<k&&void 0!==c){c=JSON.parse(c);c.x-=d/2;c.y-=q/2;c.y*=-1;c.r=Math.sqrt(c.x*c.x+c.y*c.y);for(c.theta=Math.atan2(c.y,c.x);0>c.theta;)c.theta+=f;for(;c.theta>f;)c.theta-=f}l.translate(d/2,q/2);var p,g=0;for(d=0;d<h;d++)q=b[d],p=q*e,l.beginPath(),l.moveTo(0,0),l.arc(0,0,m,-g,-(g+p),!0),l.fillStyle=r.call(this,q,d,b),l.fill(),0<k&&c&&c.theta>g&&c.theta<g+p&&this.drawArc(l,m+k/2,-g,-(g+p),!0,a.focusColor,k),g+=p;0<w&&this.drawArc(l,m+w/2,0,f,!0,a.lineColor,w);0<k&&this.addEvents()});
n.register("line",{color:"#cdf",lineColor:"#48f",lineWidth:1,delimiter:",",height:16,width:32,max:null,min:0,fill:!0},function(a){var b=this.values();1==b.length&&b.push(b[0]);var d=Math.max.apply(Math,b.concat([a.max])),e=Math.min.apply(Math,b.concat([a.min])),h=this.prepareCanvas(a.width,a.height),c=this.context,k=h.width,h=h.height,g=k/(b.length-1),d=h/(d-e),m=[],l;c.beginPath();c.moveTo(0,h+e*d);for(l=0;l<b.length;l++){var f=l*g,q=h-d*(b[l]-e);m.push({x:f,y:q});c.lineTo(f,q)}c.lineTo(k,h+e*d);
a.fill&&(c.fillStyle=a.color,c.fill());if(a.lineWidth){c.beginPath();c.moveTo(0,m[0].y);for(l=0;l<m.length;l++)c.lineTo(m[l].x,m[l].y);c.lineWidth=a.lineWidth*t;c.strokeStyle=a.lineColor;c.stroke()}});n.register("multiline",{colors:["#666666","#803E75","#FF6800"],lineColor:"#4d89f9",lineWidth:1,delimiter:",",seriesDelimiter:"|",height:16,max:null,min:0,width:32},function(a){var b=this.values(),d=[].concat.apply([],b),e=Math.max.apply(Math,d.concat([a.max])),d=Math.min.apply(Math,d.concat([a.min])),
h=this.prepareCanvas(a.width,a.height),c=this.context,k=h.width,h=h.height,g=k/(b[1].length-1),e=h/(e-d),m=a.colors,l,f;c.lineWidth=a.lineWidth*t;f=[{x:0,y:h-e*(0-d)},{x:k,y:h-e*(0-d)}];c.beginPath();c.moveTo(0,f[0].y);for(a=0;a<f.length;a++)c.lineTo(f[a].x,f[a].y);c.strokeStyle=m[0%m.length];c.stroke();for(k=0;k<b.length;k+=1){l=b[k];f=[];for(a=0;a<l.length;a++)f.push({x:a*g,y:h-e*(l[a]-d)});c.beginPath();c.moveTo(0,f[0].y);for(a=0;a<f.length;a++)c.lineTo(f[a].x,f[a].y);c.strokeStyle=m[(k+1)%m.length];
c.stroke()}});n.register("bar",{colors:["#48f"],baselineColor:"#000",baselineHeight:1,fontColour:"#000",fontStyle:"12pt Arial, sans-serif",focusColor:"#000",focusWidth:0,height:16,width:32,max:null,min:0,delimiter:",",spacing:1},function(a){var b,d,e,h,c,k,g=this.values(),m=Math.max.apply(Math,g.concat([a.max])),l=Math.min.apply(Math,g.concat([a.min])),f=this.$el.data("position"),q=this.prepareCanvas(a.width,a.height),r=this.context,p=a.spacing,s=this.colors(),n=a.focusWidth;b=a.baselineHeight;var t=
q.width,q=q.height,u=q-2*p;b&&(u-=1);var v=u/(m-l),x=(t-2*p+p)/g.length;r.fillStyle=a.baselineColor;r.fillRect(0,v*m+p-b/2,t,b);for(b=0;b<g.length;b++){d=p+b*x;c=x-p;k=g[b];e=p+u-v*(k-l);if(0===k){if(0<=l||0<m)e-=1;h=1}else h=v*g[b];k=s.call(this,k,b,g);void 0!==k&&(r.fillStyle=k);r.fillRect(d,e,c,h)}if(0<n&&f)for(f=JSON.parse(f),b=0;b<g.length;b++)if(d=p+b*x,c=x-p,f.x>=d&&f.x<=d+c){k=g[b];e=p+u-v*(k-l);if(0===k){if(0<=l||0<m)e-=1;h=1}else h=v*g[b];e+=Math.min(h,0);h=Math.abs(h);f.y>=e&&f.y<=e+h&&
(r.strokeStyle=a.focusColor,r.lineWidth=n,r.strokeRect(d-n/2,e-n/2,c+n,h+n),r.fillStyle=a.fontColour,r.font=a.fontStyle,f.x>t/2&&(r.textAlign="right"),f.y<q/2&&(r.textBaseline="top",f.y+=20),r.fillText(k+"",f.x,f.y))}0<n&&this.addEvents()})})(jQuery,document,window.devicePixelRatio||1);
