// Peity jQuery plugin version 1.2.1
// (c) 2013 Ben Pickles
//
// http://benpickles.github.io/peity
//
// Released under MIT license.
(function(u,m){var E=document.createElement("canvas").getContext,p=u.fn.peity=function(a,b){E&&this.each(function(){var c=u(this),g=c.data("peity");if(g)a&&(g.type=a),u.extend(g.opt,b),g.draw();else{var e=p.defaults[a],f={};u.each(c.data(),function(a,b){a in e&&(f[a]=b)});var h=u.extend({},e,f,b),g=new B(c,a,h);g.draw();c.change(function(a,b,c){g.draw()}).data("peity",g)}});return this},B=function(a,b,c){this.$el=a;this.type=b;this.opt=c},d=B.prototype;d.fill=function(){var a=this.opt.fill;return u.isFunction(a)?
a:function(b,c){return a[c%a.length]}};d.draw=function(){p.graphers[this.type].call(this,this.opt)};d.prepareCanvas=function(a,b){var c=this.canvas,g;c?c.width=c.width:(g=u("<canvas>").css({height:b,width:a}).addClass("peity").data("peity",this),this.canvas=c=g[0],this.context=c.getContext("2d"),this.$el.hide().after(c),c.height=g.height(),c.width=g.width());return c};d.hoverEvent=function(a){d.removeEvents(this);var b=this.getBoundingClientRect();u(this).prev().data("mouse",JSON.stringify({x:a.clientX-
b.left,y:a.clientY-b.top})).change()};d.exitEvent=function(a){d.removeEvents(this);u(this).prev().removeData("mouse").change()};d.removeEvents=function(a){a.removeEventListener("mouseout",a.exitEvent,!1);a.removeEventListener("mousemove",a.hoverEvent,!1)};d.addEvents=function(a){a.addEventListener("mousemove",d.hoverEvent,!1);a.addEventListener("mouseout",d.exitEvent,!1)};d.values=function(){var a=this.opt.delimiter,b=this.opt.seriesDelimiter,c=this.$el.text(),g=function(b){return b.split(a).map(function(a){return parseFloat(a)})};
return b?c.split(b).map(g):g(c)};d.setLineStyle=function(a,b,c){a.lineWidth=c;a.strokeStyle=b};d.drawArc=function(a,b,c,g,e,f,h,z){a.beginPath();a.arc(b,c,g,e,f,!0);d.setLineStyle(a,h,z);a.stroke()};d.drawCircle=function(a,b,c,g,e,f,h){a.beginPath();a.moveTo(b,c);a.arc(b,c,g,e,f,!0);a.fillStyle=h;a.fill()};d.drawLine=function(a,b,c,g){a.beginPath();a.moveTo(b[0].x,b[0].y);for(var e=1;e<b.length;e++)a.lineTo(b[e].x,b[e].y);this.setLineStyle(a,c,g);a.stroke()};d.drawGrid=function(a,b,c,g,e,f,h,z,k,
A,m,q,v,r,s,t){var n=function(){return m-q*(d-v)+t},d=0;b&&(a.beginPath(),a.moveTo(k,n()),a.lineTo(A,n()),this.setLineStyle(a,g,b),a.stroke());if(c)for(this.setLineStyle(a,e,c),d=v;d<=r;d+=s)a.beginPath(),a.moveTo(k,n()),a.lineTo(A,n()),a.stroke(),a.fillStyle=f,a.font=h+"px sans-serif",a.textAlign="right",a.textBaseline=n()>h/2?n()>m-h/2?"bottom":"middle":"top",a.fillText(z(d)+"",k-1,n())};p.defaults={};p.graphers={};p.register=function(a,b,c){this.defaults[a]=b;this.graphers[a]=c};p.register("pie",
{fill:["#f90","#ffd","#fc6"],lineColor:"#000",lineWidth:0,focusColor:"#000",focusWidth:0,delimiter:null,diameter:16},function(a){if(!a.delimiter){var b=this.$el.text().match(/[^0-9\.]/);a.delimiter=b?b[0]:","}b=this.values();"/"===a.delimiter&&(b=[b[0],b[1]-b[0]]);var c,g=0,e=b.length;for(c=0;c<e;c++)g+=b[c];var f=this.$el.data("mouse"),h=a.focusWidth,z=a.lineWidth,k=m.max(h,z)+1,d=a.diameter,d=this.prepareCanvas(d+k,d+k),x=this.context;c=d.width;var q=d.height,k=c/2-k,v=2*m.PI,g=v/g,r=this.fill();
if(h&&f){f=JSON.parse(f);f.x-=c/2;f.y-=q/2;f.y*=-1;f.r=m.sqrt(f.x*f.x+f.y*f.y);for(f.a=m.atan2(f.y,f.x);0>f.a;)f.a+=v;for(;f.a>v;)f.a-=v}x.translate(c/2,q/2);var s,t=0;for(c=0;c<e;c++)q=b[c],s=q*g,this.drawCircle(x,0,0,k,-t,-(t+s),r.call(this,q,c,b)),h&&f&&f.a>t&&f.a<t+s&&this.drawArc(x,0,0,k+h/2,-t,-(t+s),a.focusColor,h),t+=s;z&&this.drawArc(x,0,0,k+z/2,0,v,a.lineColor,z);h&&this.addEvents(d)});p.register("line",{fill:"#cdf",lineColor:"#48f",lineWidth:1,fontColor:"#000",fontSize:13,formatter:function(a){return a},
delimiter:",",height:150,width:400,left:0,max:null,min:0,pointSize:3,focus:!1,gridlines:[1,0],gridlineColors:["#000","#bbb"]},function(a){var b=this.$el.data("mouse"),c=this.values();1==c.length&&c.push(c[0]);var g=m.max.apply(m,c.concat([a.max])),e=m.min.apply(m,c.concat([a.min])),f=a.region||(g-e)/5,h=a.lineWidth,d=a.pointSize,k=a.focus,A=a.fontColor,x=a.fontSize,q=a.formatter,v=this.prepareCanvas(a.width,a.height),r=this.context,s=a.left+d,t=v.width,n=v.height-h,d=(t-d-s)/(c.length-1),u=n/(g-e),
w=n+e*u,y=[],l;r.beginPath();r.moveTo(s,w);for(l=0;l<c.length;l++){var p=l*d+s,D=w-u*c[l]+h/2;y.push({x:p,y:D});r.lineTo(p,D)}r.lineTo(t,w);a.fill&&(r.fillStyle=a.fill,r.fill());l=a.gridlines;w=a.gridlineColors;this.drawGrid(r,l[0],l[1],w[0],w[1],A,x,q,s,t,n,u,e,g,f,0);h&&this.drawLine(r,y,a.lineColor,h);if(a.pointSize)for(l=0;l<y.length;l++)this.drawCircle(r,y[l].x,y[l].y,a.pointSize,0,2*m.PI,a.lineColor);if(k&&b)for(b=JSON.parse(b),l=0;l<y.length;l++)if(g=y[l],b.x>=g.x-d/3&&b.x<=g.x+d/3){r.fillStyle=
a.fontColor;r.font=a.fontSize;b.x>t/2&&(r.textAlign="right");b.y<n/2&&(r.textBaseline="top",b.y+=20);r.fillText(q(c[l])+"",b.x,b.y);break}k&&this.addEvents(v)});p.register("lines",{lineColors:["#666666","#803E75"],lineWidths:[1],fontColor:"#000",fontSize:13,formatter:function(a){return a},delimiter:",",seriesDelimiter:"|",height:16,width:32,left:0,max:null,min:0,pointSizes:[2],gridlines:[1,1],gridlineColors:["#000","#bbb"]},function(a){var b=this.$el.data("mouse"),c=this.values(),g,e=a.pointSizes,
f=[].concat.apply([a.max,a.min],c);g=m.max.apply(m,f);var h=m.min.apply(m,f),d=a.region||(g-h)/5,f=this.prepareCanvas(a.width,a.height),k=this.context,A=a.left,x=f.width,q=x-2*m.max.apply(m,e)-A,v=f.height,q=q/(c[0].length-1),r=v/(g-h),s=a.lineColors,t=a.lineWidths,n=a.gridlines,u=a.gridlineColors,w=a.fontSize,y=a.formatter,l,p;this.drawGrid(k,n[0],n[1],u[0],u[1],a.fontColor,w,y,A,x,v,r,h,g,d,0);for(d=0;d<c.length;d+=1){x=c[d];n=[];for(l=0;l<x.length;l++)g=x[l],n.push({x:l*q+e[d%e.length]+A,y:v-r*
(g-h)}),this.drawCircle(k,n[l].x,n[l].y,e[d%e.length],0,2*m.PI,s[d%s.length]);this.drawLine(k,n,s[d%s.length],t[d%t.length]);0===d&&(p=n.slice(0))}if(focus&&b)for(b=JSON.parse(b),l=0;l<p.length;l++)if(e=p[l],b.x>=e.x-q/3&&b.x<=e.x+q/3){k.font=a.fontSize;k.textAlign="right";b.y<v/2?(k.textBaseline="top",b.y+=w):(k.textBaseline="bottom",b.y-=w);c.forEach(function(a,c){k.fillStyle=s[c%s.length];k.fillText((y(a[l])||" ")+" \u25a0",b.x,b.y+c*w)});break}focus&&this.addEvents(f)});p.register("bar",{fill:["#48f"],
fontColor:"#000",fontSize:13,formatter:function(a){return a},focusColor:"#000",focusWidth:0,delimiter:",",height:16,width:32,left:0,gap:1,max:null,min:0,gridlines:[1,1],gridlineColors:["#000","#bbb"]},function(a){var b,c,d=this.values();b=m.max.apply(m,d.concat([a.max]));var e=m.min.apply(m,d.concat([a.min])),f=a.region||(b-e)/5,h=this.$el.data("mouse"),u=this.prepareCanvas(a.width,a.height),k=this.context,p=a.gap,x=this.fill(),q=a.focusWidth;c=a.gridlines;var v=a.gridlineColors,r=a.fontSize,s=a.fontColor,
t=a.formatter,n=u.width,B=u.height,w=a.left,y=B-2*p-c[0],l=y/(b-e),C=(n-2*p-w+p)/d.length;this.drawGrid(k,c[0],c[1],v[0],v[1],s,r,t,w,n,y,l,e,b,f,p);f=[];for(b=0;b<d.length;b++)c=d[b],f.push([p+b*C+w,y-l*(c-e)+p,C-p,0===c?1:l*c]),k.fillStyle=x.call(this,c,b,d),k.fillRect.apply(k,f[b]);if(q&&h)for(h=JSON.parse(h),b=0;b<f.length;b++)if(e=f[b],h.x>=e[0]&&h.x<=e[0]+e[2]){e[1]+=m.min(e[3],0);e[3]=m.abs(e[3]);h.y>=e[1]&&h.y<=e[1]+e[3]&&(this.setLineStyle(k,a.focusColor,q),k.strokeRect(e[0]-q/2,e[1]-q/2,
e[2]+q,e[3]+q),k.fillStyle=s,k.font=r,h.x>n/2&&(k.textAlign="right"),h.y<B/2&&(k.textBaseline="top",h.y+=20),k.fillText(t(d[b])+"",h.x,h.y));break}q&&this.addEvents(u)})})(jQuery,Math);
