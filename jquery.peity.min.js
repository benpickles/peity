// Peity jQuery plugin version 1.2.1
// (c) 2013 Ben Pickles
// http://benpickles.github.io/peity
//
// Peity jQuery plugin version 0.9.0
// (c) 2014 Fred Morel
// http://fmorel90.github.io/peity
//
// Released under MIT license.
(function(l,p){var O=document.createElement("canvas").getContext,w=l.fn.peity=function(a,b){O&&this.each(function(){var c=l(this),e=c.data("peity");if(e)a&&(e.type=a),l.extend(!0,e.opt,b),e.draw();else{var f=w.defaults[a],d={};l.each(c.data(),function(a,b){d[a]=b});f=l.extend({},f,d,b);e=new M(c,a,f);e.draw();c.change(function(){e.draw()}).data("peity",e)}});return this},M=function(a,b,c){this.$el=a;this.type=b;this.opt=c},J=M.prototype;J.fill=function(){var a=this.opt.fill;return l.isArray(a)?l.isArray(a[0])||
l.isFunction(a[0])?a.map(function(a){return l.isFunction(a)?a:function(c,e){return a[e%a.length]}}):function(b,c){return a[c%a.length]}:a};J.draw=function(){w.graphers[this.type].call(this,this.opt)};J.prepareCanvas=function(a,b){var c=this.canvas;if(c)c.width=c.width;else{var e=l("<canvas class='peity'>").css({height:b,width:a}).data("peity",this);this.canvas=c=e[0];this.context=c.getContext("2d");this.$el.hide().after(c);c.height=e.height();c.width=e.width()}return c};J.values=function(){var a=
arguments,b=this.$el.text().split(a[0]);return 1===a.length?u.parseFloats(b):b.map(function(b){return u.parseFloats(b.split(a[1]))})};var u={defaultText:{color:"#000",size:13,formatter:function(a){return a}},labelLeveler:function(a){return p.max.apply(this,a.map(function(a){return a.replace(/[^ ]/g,"").length}))+1},stringifier:function(a,b){return b?a.map(function(a){return b(a)+""}):a.map(function(a){return a+""})},parseFloats:function(a){return a.map(function(a){return parseFloat(a)})},extractor:function(a){return function(b){return b[a]}},
toFunction:function(a){return l.isArray(a)?l.isArray(a[0])||l.isFunction(a[0])?a.map(function(a){return l.isFunction(a)?a:function(c,e){return a[e%a.length]}}):function(b,c){return a[c%a.length]}:a}},N=function(a){var b=this.getBoundingClientRect();l(this).off().prev().data("mouse",JSON.stringify({x:a.clientX-b.left,y:a.clientY-b.top})).change()},K=function(a){l(a).on("mousemove",N).on("mouseout",N)},y={arc:function(a,b,c,e,f,d,g,h){a.beginPath();a.arc(b,c,e,f,d,!0);a.lineWidth=h;a.strokeStyle=g;
a.stroke()},circle:function(a,b,c,e,f,d,g){a.beginPath();a.moveTo(b,c);a.arc(b,c,e,f,d,!0);a.fillStyle=g;a.fill()},line:function(a,b,c,e){var f;a.beginPath();a.moveTo(b[0].x,b[0].y);for(f=1;f<b.length;f++)a.lineTo(b[f].x,b[f].y);a.lineWidth=e;a.strokeStyle=c;a.stroke()},rect:function(a,b,c,e,f,d,g,h){d&&(a.fillStyle=d,a.fillRect(b,c,e,f));h&&(a.strokeStyle=h,a.lineWidth=g,a.strokeRect(b,c,e,f))},drawYAxis:function(a,b,c,e,f,d,g,h,q,n,z,r,p,u,v,s){var k=z-r*(0-p)+s;b&&y.line(a,[{x:q,y:k},{x:n,y:k}],
e,b);if(c)for(a.fillStyle=d,a.font=g+"px sans-serif",a.textAlign="right",b=p;b<=u;b+=v)k=z-r*(b-p)+s,y.line(a,[{x:q,y:k},{x:n,y:k}],f,c),q&&(a.textBaseline=k>g/2?k>z-g/2?"bottom":"middle":"top",a.fillText(h(b)+"",q-2,k))},drawXAxis:function(a,b,c,e,f,d){var g,h;a.fillStyle=b;a.font=c+"px sans-serif";a.textBaseline="top";a.textAlign="center";for(b=0;b<f.length;b++)for(h=d[b].split(" "),g=0;g<h.length;g++)a.fillText(h[g],f[b].x,e+1+g*c)},tooltip:function(a,b,c,e,f,d,g,h){a.font=d+"px sans-serif";a.textAlign=
"left";a.textBaseline="top";var q=a.measureText("\u25a0").width;h=u.stringifier(e,h);var n=p.max.apply([],h.map(function(b){return a.measureText(b).width}));b-=6;c>e.length*d+6&&(c-=e.length*d);b<=n+q+7&&(b+=n+q+20+7);y.rect(a,b-n-q-4,c-3,n+q+7,e.length*d+8,"#fff",1,"#000");h.forEach(function(e,h){a.fillStyle=f[h%f.length];a.fillText("\u25a0",b-n-q-3,c+h*d);a.fillStyle=g;a.fillText(e,b-n-2,c+h*d)})}};w.defaults={};w.graphers={};w.register=function(a,b,c){this.defaults[a]=b;this.graphers[a]=c};w.register("pie",
{fill:["#f90","#ffd","#fc6"],line:{color:"#000",width:0},focus:{color:"#000",width:0},delimiter:null,diameter:16,tooltip:u.defaultText},function(a){var b=a.delimiter;b||(b=(b=this.$el.text().match(/[^0-9\.]/))?b[0]:",");var c=this.values.apply(this,[b]);"/"===b&&(c=[c[0],c[1]-c[0]]);var e,f=0,b=c.length;for(e=0;e<b;e++)f+=c[e];var d=this.$el.data("mouse"),g=a.focus,h=a.line,q=p.max(g.width,h.width)+1,n=a.diameter,n=this.prepareCanvas(n+q,n+q),z=this.context;e=n.width;var r=n.height,q=e/2-q,l=2*p.PI,
f=l/f,x=u.toFunction(a.fill);a=a.tooltip;var v;if(g.width&&d){d=JSON.parse(d);d.x-=e/2;d.y-=r/2;d.y*=-1;d.r=p.sqrt(d.x*d.x+d.y*d.y);for(d.a=p.atan2(d.y,d.x);0>d.a;)d.a+=l;for(;d.a>l;)d.a-=l}z.save();z.translate(e/2,r/2);var s,k=0;for(e=0;e<b;e++)r=c[e],s=r*f,y.circle(z,0,0,q,-k,-(k+s),x.call(this,r,e,c)),g.width&&d&&d.a>k&&d.a<k+s&&d.r<q&&(y.arc(z,0,0,q+g.width/2,-k,-(k+s),g.color,g.width),v=e),k+=s;h.width&&y.arc(z,0,0,q+h.width/2,0,l,h.color,h.width);g.width&&(d&&void 0!==v&&(d=JSON.parse(this.$el.data("mouse")),
z.restore(),y.tooltip(z,d.x,d.y,[c[v]],[x.call(this,c[v],v,c)],a.size,a.color,a.formatter)),K(n))});w.register("line",{lineColors:["#78A","#827"],lineWidths:[1],fill:"#cdf",delimiters:["|",","],height:32,width:32,left:0,max:null,min:0,pointSizes:[2],xAxis:u.defaultText,yAxis:u.defaultText,tooltip:u.defaultText,focus:!1,gridlines:{widths:[1,0],colors:["#000","#bbb"]}},function(a){var b=this.$el.data("mouse"),c=this.values.apply(this,a.delimiters),e,f=a.pointSizes,d=a.xAxis,g=a.yAxis,h=a.focus,q=a.tooltip,
n=a.gridlines,l=[].concat.apply([a.max,a.min],c),r=a.labels,w=0;r&&(r=u.stringifier(r),w=u.labelLeveler(r));var x=p.max.apply(p,l),v=p.min.apply(p,l),s=a.region||(x-v)/5,x=p.ceil(x/s)*s,v=p.floor(v/s)*s,l=this.prepareCanvas(a.width,a.height),k=this.context,G=a.left,B=w*d.size+(w?4:0),A=l.width,C=A-2*p.max.apply(p,f)-G,B=l.height-B,C=C/(c[0].length-0.5),H=B/(x-v),E=u.toFunction(a.lineColors),I=a.lineWidths,F=a.fill,m,t,L,D;a=[];for(t=0;t<c.length;t+=1){L=c[t];D=[];for(m=0;m<L.length;m++)e=L[m],D.push({x:m*
C+f[t%f.length]+G+C/4,y:B-H*(e-v)});if(F&&1===c.length){k.beginPath();e=0;k.moveTo(G+C/4+f[0],B-H*(e-v));for(m=0;m<D.length;m++)k.lineTo(D[m].x,D[m].y);e=0;k.lineTo(A-f[0]-C/4,B-H*(e-v));k.fillStyle=F;k.fill()}a.push(D)}y.drawYAxis(k,n.widths[0],n.widths[1],n.colors[0],n.colors[1],g.color,g.size,g.formatter,G,A,B,H,v,x,s,0);for(t=0;t<c.length;t+=1){D=a[t];E[t]=E.call(this,c[t][m],t,c[t]);for(m=0;m<D.length;m++)y.circle(k,D[m].x,D[m].y,f[t%f.length],0,2*p.PI,E[t]);y.line(k,D,E[t],I[t%I.length])}w&&
y.drawXAxis(k,d.color,d.size,B,a[0],r);if(h&&b)for(b=JSON.parse(b),m=0;m<a[0].length;m++)if(f=a[0][m],b.x>=f.x-C/3&&b.x<=f.x+C/3){y.tooltip(k,b.x,b.y,c.map(u.extractor(m)),E,q.size,q.color,q.formatter);break}h&&K(l)});w.register("bar",{fill:[["#48f"],["#f90"],["#99f"]],delimiters:["|",","],height:16,width:32,left:0,gap:1,seriesGap:0,max:null,min:0,xAxis:u.defaultText,yAxis:u.defaultText,tooltip:u.defaultText,focus:{color:"#000",width:0},gridlines:{widths:[1,0],colors:["#000","#bbb"]}},function(a){var b=
this,c=b.values.apply(b,a.delimiters),e=c.length,f=[].concat.apply([a.max,a.min],c),d,g,h,l=a.labels,n=0;l&&(l=u.stringifier(l),n=u.labelLeveler(l));d=p.max.apply(p,f);f=p.min.apply(p,f);h=a.region||(d-f)/5;d=p.ceil(d/h)*h;var f=p.floor(f/h)*h,z=u.toFunction(a.fill),r=a.yAxis,w=a.xAxis,x=a.focus,v=a.tooltip,s=a.gridlines,k=b.$el.data("mouse"),G=b.prepareCanvas(a.width,a.height),B=b.context,A=G.width,C=a.gap,H=a.seriesGap;a=a.left;var E=G.height-(n*w.size+(n?4:0))-s.widths[0],I=E/(d-f),F=(A-a-C*c[0].length)/
c[0].length;y.drawYAxis(B,s.widths[0],s.widths[1],s.colors[0],s.colors[1],r.color,r.size,r.formatter,a,A,E,I,f,d,h,0);var m=[],t=[];for(g=0;g<c.length;g++){s=c[g];r=[];for(h=0;h<c[g].length;h++)t[h]={x:a+C/2+h*(C+F)+F/2},d=s[h],A=[a+C/2+h*(C+F)+F/e*g,E-I*(d-f),F/e-H/2,0===d?1:I*d],r.push(A),y.rect(B,A[0],A[1],A[2],A[3],z[g%z.length].call(b,d,h,c[g]),0);0===g&&r.slice(0);m.push(r.slice(0))}n&&y.drawXAxis(B,w.color,w.size,E,t,l);if(x.width&&k)for(k=JSON.parse(k),g=0;g<m[0].length;g++)if(A=m[0][g],k.x>=
A[0]&&k.x<=A[0]+F){for(h=0;h<m.length;h++)y.rect(B,m[h][g][0]-x.width/2,m[h][g][1]-x.width/2,m[h][g][2]+x.width,m[h][g][3]+x.width,void 0,x.width,x.color);y.tooltip(B,k.x,k.y,c.map(u.extractor(g)),c.map(function(a,c){return z[c].call(b,a[g],g,a)}),v.size,v.color,v.formatter);break}x.width&&K(G)})})(jQuery,Math);
