// Peity jQuery plugin version 1.2.1
// (c) 2013 Ben Pickles
//
// http://benpickles.github.io/peity
//
// Released under MIT license.
(function(r,p){var H=document.createElement("canvas").getContext,y=r.fn.peity=function(a,b){H&&this.each(function(){var c=r(this),e=c.data("peity");if(e)a&&(e.type=a),r.extend(!0,e.opt,b),e.draw();else{var f=y.defaults[a],d={};r.each(c.data(),function(a,b){a in f&&(d[a]=b)});var q=r.extend(!0,{},f,d,b),e=new G(c,a,q);e.draw();c.change(function(a,b,c){e.draw()}).data("peity",e)}});return this},G=function(a,b,c){this.$el=a;this.type=b;this.opt=c},g=G.prototype;g.fill=function(){var a=this.opt.fill;
return r.isFunction(a)?a:function(b,c){return a[c%a.length]}};g.draw=function(){y.graphers[this.type].call(this,this.opt)};g.prepareCanvas=function(a,b){var c=this.canvas,e;c?c.width=c.width:(e=r("<canvas>").css({height:b,width:a}).addClass("peity").data("peity",this),this.canvas=c=e[0],this.context=c.getContext("2d"),this.$el.hide().after(c),c.height=e.height(),c.width=e.width());return c};g.hoverEvent=function(a){g.removeEvents(this);var b=this.getBoundingClientRect();r(this).prev().data("mouse",
JSON.stringify({x:a.clientX-b.left,y:a.clientY-b.top})).change()};g.exitEvent=function(a){g.removeEvents(this);r(this).prev().removeData("mouse").change()};g.removeEvents=function(a){a.removeEventListener("mouseout",a.exitEvent,!1);a.removeEventListener("mousemove",a.hoverEvent,!1)};g.addEvents=function(a){a.addEventListener("mousemove",g.hoverEvent,!1);a.addEventListener("mouseout",g.exitEvent,!1)};g.values=function(){var a=this.opt.delimiter,b=this.opt.seriesDelimiter,c=this.$el.text(),e=function(b){return b.split(a).map(function(a){return parseFloat(a)})};
return b?c.split(b).map(e):e(c)};g.setLineStyle=function(a,b,c){a.lineWidth=c;a.strokeStyle=b};g.drawArc=function(a,b,c,e,f,d,q,n){a.beginPath();a.arc(b,c,e,f,d,!0);g.setLineStyle(a,q,n);a.stroke()};g.drawCircle=function(a,b,c,e,f,d,q){a.beginPath();a.moveTo(b,c);a.arc(b,c,e,f,d,!0);a.fillStyle=q;a.fill()};g.drawLine=function(a,b,c,e){a.beginPath();a.moveTo(b[0].x,b[0].y);for(var f=1;f<b.length;f++)a.lineTo(b[f].x,b[f].y);this.setLineStyle(a,c,e);a.stroke()};g.drawYAxis=function(a,b,c,e,f,d,q,n,h,
p,k,g,s,v,x,l){var m=function(){return k-g*(u-s)+l},u=0;b&&(a.beginPath(),a.moveTo(h,m()),a.lineTo(p,m()),this.setLineStyle(a,e,b),a.stroke());if(c)for(this.setLineStyle(a,f,c),u=s;u<=v;u+=x)a.beginPath(),a.moveTo(h,m()),a.lineTo(p,m()),a.stroke(),3<h&&(a.fillStyle=d,a.font=q+"px sans-serif",a.textAlign="right",a.textBaseline=m()>q/2?m()>k-q/2?"bottom":"middle":"top",a.fillText(n(u)+"",h-1,m()))};g.drawXAxis=function(a,b,c,e,f,d){a.fillStyle=b;a.font=c+"px sans-serif";a.textBaseline="top";a.textAlign=
"center";for(b=0;b<f.length;b++)for(var q=d[b].split(" "),n=0;n<q.length;n++)a.fillText(q[n],f[b].x,e+1+n*c)};y.defaults={};y.graphers={};y.register=function(a,b,c){this.defaults[a]=b;this.graphers[a]=c};y.register("pie",{fill:["#f90","#ffd","#fc6"],lineColor:"#000",lineWidth:0,focusColor:"#000",focusWidth:0,delimiter:null,diameter:16},function(a){if(!a.delimiter){var b=this.$el.text().match(/[^0-9\.]/);a.delimiter=b?b[0]:","}b=this.values();"/"===a.delimiter&&(b=[b[0],b[1]-b[0]]);var c,e=0,f=b.length;
for(c=0;c<f;c++)e+=b[c];var d=this.$el.data("mouse"),q=a.focusWidth,n=a.lineWidth,h=p.max(q,n)+1,g=a.diameter,g=this.prepareCanvas(g+h,g+h),k=this.context;c=g.width;var A=g.height,h=c/2-h,s=2*p.PI,e=s/e,v=this.fill();if(q&&d){d=JSON.parse(d);d.x-=c/2;d.y-=A/2;d.y*=-1;d.r=p.sqrt(d.x*d.x+d.y*d.y);for(d.a=p.atan2(d.y,d.x);0>d.a;)d.a+=s;for(;d.a>s;)d.a-=s}k.translate(c/2,A/2);var x,l=0;for(c=0;c<f;c++)A=b[c],x=A*e,this.drawCircle(k,0,0,h,-l,-(l+x),v.call(this,A,c,b)),q&&d&&d.a>l&&d.a<l+x&&this.drawArc(k,
0,0,h+q/2,-l,-(l+x),a.focusColor,q),l+=x;n&&this.drawArc(k,0,0,h+n/2,0,s,a.lineColor,n);q&&this.addEvents(g)});y.register("line",{fill:"#cdf",lineColor:"#48f",lineWidth:1,delimiter:",",height:150,width:400,left:0,max:null,min:0,pointSize:3,focus:!1,xAxis:{color:"#000",size:13,formatter:function(a){return a}},yAxis:{color:"#000",size:13,formatter:function(a){return a}},focus:{color:"#000",width:0},tooltip:{color:"#000",size:13,formatter:function(a){return a}},gridlines:{widths:[1,1],colors:["#000",
"#bbb"]}},function(a){var b=this.$el.data("mouse"),c=this.values();1==c.length&&c.push(c[0]);var e=a.labels;e&&(e=e.map(function(a){return a+""}));var f=0;e&&(f=p.max.apply(this,e.map(function(a){return a.replace(/[^ ]/g,"").length}))+1);var d=p.max.apply(p,c.concat([a.max])),q=p.min.apply(p,c.concat([a.min])),n=a.region||(d-q)/5,h=a.lineWidth,g=a.pointSize,k=a.focus,A=a.xAxis,s=a.yAxis,v=a.tooltip,x=a.gridlines,l=this.prepareCanvas(a.width,a.height),m=this.context,u=a.left+g,D=l.width,z=l.height-
h-(f*A.size+4),C=(D-g-u)/(c.length-1),B=z/(d-q),E=z+q*B,w=[],t;m.beginPath();m.moveTo(u,E);for(t=0;t<c.length;t++){var r=t*C+u,y=E-B*c[t]+h/2;w.push({x:r,y:y});m.lineTo(r,y)}m.lineTo(D-g/2,E);a.fill&&(m.fillStyle=a.fill,m.fill());this.drawYAxis(m,x.widths[0],x.widths[1],x.colors[0],x.colors[1],s.color,s.size,s.formatter,u,D,z,B,q,d,n,0);h&&this.drawLine(m,w,a.lineColor,h);if(a.pointSize)for(t=0;t<w.length;t++)this.drawCircle(m,w[t].x,w[t].y,a.pointSize,0,2*p.PI,a.lineColor);f&&this.drawXAxis(m,A.color,
A.size,z,w,e);if(k&&b)for(b=JSON.parse(b),t=0;t<w.length;t++)if(a=w[t],b.x>=a.x-C/3&&b.x<=a.x+C/3){m.fillStyle=v.color;m.font=v.size+"px sans-serif";b.x>D/2&&(m.textAlign="right");b.y<z/2&&(m.textBaseline="top",b.y+=20);m.fillText(v.formatter(c[t])+"",b.x,b.y);break}k&&this.addEvents(l)});y.register("lines",{lineColors:["#666666","#803E75"],lineWidths:[1],delimiter:",",seriesDelimiter:"|",height:16,width:32,left:0,max:null,min:0,pointSizes:[2],xAxis:{color:"#000",size:13,formatter:function(a){return a}},
yAxis:{color:"#000",size:13,formatter:function(a){return a}},focus:!1,tooltip:{color:"#000",size:13,formatter:function(a){return a}},gridlines:{widths:[1,1],colors:["#000","#bbb"]}},function(a){var b=this.$el.data("mouse"),c=this.values(),e=a.pointSizes,f=a.xAxis,d=a.yAxis,g=a.focus,n=a.tooltip,h=a.gridlines,r=[].concat.apply([a.max,a.min],c),k=a.labels;k&&(k=k.map(function(a){return a+""}));var A=0;k&&(A=p.max.apply(this,k.map(function(a){return a.replace(/[^ ]/g,"").length}))+1);var s=p.max.apply(p,
r),v=p.min.apply(p,r),x=a.region||(s-v)/5,r=this.prepareCanvas(a.width,a.height),l=this.context,m=a.left,u=A*f.size+4,y=r.width,z=y-2*p.max.apply(p,e)-m,u=r.height-u,z=z/(c[0].length-0.5),C=u/(s-v),B=a.lineColors,E=a.lineWidths,h=a.gridlines,w,t,F;this.drawYAxis(l,h.widths[0],h.widths[1],h.colors[0],h.colors[1],d.color,d.size,d.formatter,m,y,u,C,v,s,x,0);for(d=0;d<c.length;d+=1){s=c[d];t=[];for(w=0;w<s.length;w++)a=s[w],t.push({x:w*z+e[d%e.length]+m+z/4,y:u-C*(a-v)}),this.drawCircle(l,t[w].x,t[w].y,
e[d%e.length],0,2*p.PI,B[d%B.length]);this.drawLine(l,t,B[d%B.length],E[d%E.length]);0===d&&(F=t.slice(0))}A&&this.drawXAxis(l,f.color,f.size,u,t,k);if(g&&b)for(b=JSON.parse(b),w=0;w<F.length;w++)if(e=F[w],b.x>=e.x-z/3&&b.x<=e.x+z/3){l.font=n.size+"px sans-serif";l.textAlign="right";b.y<u/2?(l.textBaseline="top",b.y+=n.size):(l.textBaseline="bottom",b.y-=n.size);c.forEach(function(a,c){l.fillStyle=B[c%B.length];l.fillText((n.formatter(a[w])||" ")+" \u25a0",b.x,b.y+c*n.size)});break}g&&this.addEvents(r)});
y.register("bar",{fill:["#48f"],delimiter:",",height:40,width:100,left:0,gap:1,xAxis:{color:"#000",size:13,formatter:function(a){return a}},yAxis:{color:"#000",size:13,formatter:function(a){return a}},focus:{color:"#000",width:0},tooltip:{color:"#000",size:13,formatter:function(a){return a}},gridlines:{widths:[1,1],colors:["#000","#bbb"]},max:null,min:0},function(a){var b,c,e=this.values(),f=a.labels;f&&(f=f.map(function(a){return a+""}));var d=0;f&&(d=p.max.apply(this,f.map(function(a){return a.replace(/[^ ]/g,
"").length}))+1);b=p.max.apply(p,e.concat([a.max]));var g=p.min.apply(p,e.concat([a.min])),n=a.region||(b-g)/5,h=this.$el.data("mouse"),r=this.prepareCanvas(a.width,a.height),k=this.context,y=this.fill();c=a.yAxis;var s=a.xAxis,v=a.focus,x=a.tooltip,l=a.gridlines,m=r.width,u=r.height,D=a.gap;a=a.left;var z=u-(d*s.size+4)-l.widths[0],C=z/(b-g),B=(m-2*D-a+D)/e.length;this.drawYAxis(k,l.widths[0],l.widths[1],l.colors[0],l.colors[1],c.color,c.size,c.formatter,a,m,z,C,g,b,n,0);n=[];for(b=0;b<e.length;b++)c=
e[b],n.push([a+b*B+D,z-C*(c-g),B-D,0===c?1:C*c]),k.fillStyle=y.call(this,c,b,e),k.fillRect.apply(k,n[b]);d&&this.drawXAxis(k,s.color,s.size,z,n.map(function(a){return{x:a[0]+a[2]/2}}),f);if(v.width&&h)for(h=JSON.parse(h),b=0;b<n.length;b++)if(f=n[b],h.x>=f[0]&&h.x<=f[0]+f[2]){f[1]+=p.min(f[3],0);f[3]=p.abs(f[3]);h.y>=f[1]&&h.y<=f[1]+f[3]&&(this.setLineStyle(k,v.color,v.width),k.strokeRect(f[0]-v.width/2,f[1]-v.width/2,f[2]+v.width,f[3]+v.width),k.fillStyle=x.color,k.font=x.size+"px sans-serif",h.x>
m/2&&(k.textAlign="right"),h.y<u/2?(k.textBaseline="top",h.y+=20):k.textBaseline="bottom",k.fillText(x.formatter(e[b])+"",h.x,h.y));break}v.width&&this.addEvents(r)})})(jQuery,Math);
