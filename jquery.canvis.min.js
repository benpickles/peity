// Peity jQuery plugin version 1.2.1
// (c) 2013 Ben Pickles
// http://benpickles.github.io/peity
//
// CanVis jQuery plugin version 0.9.0
// (c) 2014 Fred Morel
// http://fmorel90.github.io/peity
//
// Released under MIT license.
(function(p,u){var K=document.createElement("canvas").getContext,s=p.fn.canvis=function(a,b){K&&this.each(function(){var c=p(this),f=c.data("canvis");if(f)a&&(f.type=a),p.extend(!0,f.opt,b),f.draw();else{var h=s.defaults[a],d={};p.each(c.data(),function(a,b){d[a]=b});h=p.extend({},h,d,b);f=new F(c,a,h);f.draw();c.change(function(){f.draw()}).data("canvis",f)}});return this},F=function(a,b,c){this.$el=a;this.type=b;this.opt=c},v=F.prototype;v.draw=function(){s.graphers[this.type].call(this,this.opt)};
v.prepareCanvas=function(a,b){var c=this.canvas;c||(this.canvas=c=p("<canvas class='canvis'>")[0],this.context=c.getContext("2d"),this.$el.hide().removeData("mouse").after(c));c.width=a;c.height=b;p(c).css({height:b,width:a}).data("canvis",this).off();return c};v.values=function(){var a=function(a){return parseFloat(a)},b=arguments,c=this.$el.text().split(b[0]);return 1===b.length?c.map(a):c.map(function(c){return c.split(b[1]).map(a)})};var v={color:"#000",size:13,formatter:function(a){return a}},
y={labelLevels:function(a){return u.max.apply(this,a.map(function(a){return a.replace(/[^ ]/g,"").length}))+1},toString:function(a,b){return b?a.map(function(a){return b(a)+""}):a.map(function(a){return a+""})},extractor:function(a){return function(b){return b[a]}},toFunction:function(a){return p.isArray(a)?p.isArray(a[0])||p.isFunction(a[0])?a.map(function(a){return p.isFunction(a)?a:function(c,f){return a[f%a.length]}}):function(b,c){return a[c%a.length]}:a},getWidth:function(a,b){return a.measureText(b).width}},
D=function(a){var b=this.getBoundingClientRect();p(this).off().prev().data("mouse",JSON.stringify({x:a.clientX-b.left,y:a.clientY-b.top})).change()},J=function(a){p(a).on("mousemove",D).on("mouseout",D)},t={arc:function(a,b,c,f,h,d,g,e){a.beginPath();a.arc(b,c,f,h,d,!0);a.lineWidth=e;a.strokeStyle=g;a.stroke()},circle:function(a,b,c,f,h,d,g){a.beginPath();a.moveTo(b,c);a.arc(b,c,f,h,d,!0);a.fillStyle=g;a.fill()},line:function(a,b,c,f){a.beginPath();a.moveTo(b[0].x,b[0].y);for(var h=1;h<b.length;h++)a.lineTo(b[h].x,
b[h].y);a.lineWidth=f;a.strokeStyle=c;a.stroke()},rect:function(a,b,c,f,h,d,g,e){d&&(a.fillStyle=d,a.fillRect(b,c,f,h));e&&(a.strokeStyle=e,a.lineWidth=g,a.strokeRect(b,c,f,h))},drawYAxis:function(a,b,c,f,h,d,g,e,k,r,l,m,z,A,w,q){var n=l-m*(0-z)+q;b&&t.line(a,[{x:k,y:n},{x:r,y:n}],f,b);if(c)for(a.fillStyle=d,a.font=g+"px sans-serif",a.textAlign="right",b=z;b<=A;b+=w)n=l-m*(b-z)+q,t.line(a,[{x:k,y:n},{x:r,y:n}],h,c),k&&(a.textBaseline=n>g/2?n>l-g/2?"bottom":"middle":"top",a.fillText(e(b)+"",k-2,n))},
drawXAxis:function(a,b,c,f,h,d){var g,e;a.fillStyle=b;a.font=c+"px sans-serif";a.textBaseline="top";a.textAlign="center";for(b=0;b<h.length;b++)for(e=d[b].split(" "),g=0;g<e.length;g++)a.fillText(e[g],h[b].x,f+1+g*c)},tooltip:function(a,b,c,f,h,d,g,e,k,r){a.font=d+"px sans-serif";a.textAlign="left";a.textBaseline="top";f=y.toString(f,e);k&&f.splice(0,0,y.toString([k],r)[0]);var l=u.max.apply([],f.map(function(b){return y.getWidth(a,b)}));e=y.getWidth(a,"\u25a0");var m=l+e;b-=6;r=f.length*d;c>r-6&&
(c-=r);b<=l+e+7&&(b+=l+e+20+7);t.rect(a,b-m-4,c-3,m+7,r+8,"#fff",1,"#000");k&&(a.fillStyle=g,a.fillText(f.splice(0,1)[0],b-m-2,c),c+=d);f.forEach(function(e,f){var k=c+f*d;a.fillStyle=h[f%h.length];a.fillText("\u25a0",b-m-3,k);a.fillStyle=g;a.fillText(e,b-l-2,k)})}};s.defaults={};s.graphers={};s.register=function(a,b,c){this.defaults[a]=b;this.graphers[a]=c};s.register("pie",{fill:["#f90","#ffd","#fc6"],line:{color:"#000",width:0},focus:{color:"#000",width:0},delimiter:null,diameter:16,tooltip:v},
function(a){var b=a.delimiter;b||(b=(b=this.$el.text().match(/[^0-9\.]/))?b[0]:",");var c=this.values.apply(this,[b]);"/"===b&&(c=[c[0],c[1]-c[0]]);var f,h=0,b=c.length;for(f=0;f<b;f++)h+=c[f];var d=this.$el.data("mouse"),g=a.focus,e=a.line,k=u.max(g.width,e.width)+1,r=a.diameter,r=this.prepareCanvas(r+k,r+k),l=this.context;f=r.width;var m=r.height,k=f/2-k,z=2*u.PI,h=z/h,p=y.toFunction(a.fill);a=a.tooltip;var w;if(g.width&&d){d=JSON.parse(d);d.x-=f/2;d.y-=m/2;d.y*=-1;d.r=u.sqrt(d.x*d.x+d.y*d.y);for(d.a=
u.atan2(d.y,d.x);0>d.a;)d.a+=z;for(;d.a>z;)d.a-=z}l.save();l.translate(f/2,m/2);var q,n=0;for(f=0;f<b;f++)m=c[f],q=m*h,t.circle(l,0,0,k,-n,-(n+q),p.call(this,m,f,c)),g.width&&d&&d.a>n&&d.a<n+q&&d.r<k&&(t.arc(l,0,0,k+g.width/2,-n,-(n+q),g.color,g.width),w=f),n+=q;e.width&&t.arc(l,0,0,k+e.width/2,0,z,e.color,e.width);g.width&&(d&&void 0!==w&&(d=JSON.parse(this.$el.data("mouse")),l.restore(),t.tooltip(l,d.x,d.y,[c[w]],[p.call(this,c[w],w,c)],a.size,a.color,a.formatter)),J(r))});s.register("combo",{series:[{type:"bar",
color:["#48f"]},{type:"line",color:["#827"],width:1,points:3}],delimiters:["|",","],height:50,width:200,left:0,gap:1,seriesGap:0,max:null,min:0,xAxis:v,yAxis:v,tooltip:v,focus:{color:"#000",width:0},gridlines:{widths:[1,0],colors:["#000","#bbb"]}},function(a){var b=this,c=b.values.apply(b,a.delimiters),f=c.length,h=[].concat.apply([a.max,a.min],c),d,g,e,k=a.labels,r=0;k&&(k=y.toString(k),r=y.labelLevels(k));d=u.max.apply(u,h);h=u.min.apply(u,h);e=a.region||(d-h)/5;0!==d&&(d=u.ceil(d+e/2));0!==h&&
(h=u.floor(h-e/2));e=a.region||(d-h)/5;var l=a.series,m=a.yAxis,p=a.xAxis,A=a.focus,w=a.tooltip,q=a.gridlines,n=b.$el.data("mouse"),v=b.prepareCanvas(a.width,a.height),s=b.context,x=v.width,E=a.gap,F=a.seriesGap;a=a.left;var G=v.height-(r*p.size+(r?4:0))-q.widths[0],H=G/(d-h),C=(x-a-E*c[0].length)/c[0].length;t.drawYAxis(s,q.widths[0],q.widths[1],q.colors[0],q.colors[1],m.color,m.size,m.formatter,a,x,G,H,h,d,e,0);var B=[],D=[];for(g=0;g<c.length;g++){var q=c[g],I=l[g].color=y.toFunction(l[g].color),
m=[];for(e=0;e<q.length;e++)D[e]={x:a+E/2+e*(E+C)+C/2},d=q[e],x=[a+E/2+e*(E+C)+C/f*g,G-H*(d-h),C/f-F/2,0===d?1:H*d],m.push(x),"bar"===l[g].type&&t.rect(s,x[0],x[1],x[2],x[3],I.call(b,d,e,c[g]),0);if("line"===l[g].type){for(e=0;e<m.length;e++)t.circle(s,m[e][0],m[e][1],l[g].points,0,2*u.PI,I.call(b,q[e],e,q));t.line(s,m.map(function(a){return{x:a[0],y:a[1]}}),I.call(b,q[0],0,q),l[g].width)}0===g&&m.slice(0);B.push(m.slice(0))}r&&t.drawXAxis(s,p.color,p.size,G,D,k);if(A.width){if(n)for(n=JSON.parse(n),
g=0;g<B[0].length;g++)if(x=B[0][g],n.x>=x[0]&&n.x<=x[0]+C){for(e=0;e<B.length;e++)"bar"===l[e].type&&t.rect(s,B[e][g][0]-A.width/2,B[e][g][1]-A.width/2,B[e][g][2]+A.width,B[e][g][3]+A.width,void 0,A.width,A.color);t.tooltip(s,n.x,n.y,c.map(y.extractor(g)),c.map(function(a,c){return l[c].color.call(b,a[g],g,a)}),w.size,w.color,w.formatter,k?k[g]:void 0,p.formatter);break}J(v)}})})(jQuery,Math);
