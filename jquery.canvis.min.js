// Peity jQuery plugin version 1.2.1
// (c) 2013 Ben Pickles
// http://benpickles.github.io/peity
//
// CanVis jQuery plugin version 0.9.0
// (c) 2014 Fred Morel
// http://fmorel90.github.io/peity
//
// Released under MIT license.
(function(p,u){var N=document.createElement("canvas").getContext,D=p.fn.canvis=function(a,b){N&&this.each(function(){var c=p(this),e=c.data("canvis");if(e)a&&(e.type=a),p.extend(!0,e.opt,b),e.draw();else{var g=D.defaults[a],d={};p.each(c.data(),function(a,b){d[a]=b});g=p.extend({},g,d,b);e=new L(c,a,g);e.draw();c.change(function(){e.draw()}).data("canvis",e)}});return this},L=function(a,b,c){this.$el=a;this.type=b;this.opt=c},v=L.prototype;v.fill=function(){var a=this.opt.fill;return p.isArray(a)?
p.isArray(a[0])||p.isFunction(a[0])?a.map(function(a){return p.isFunction(a)?a:function(c,e){return a[e%a.length]}}):function(b,c){return a[c%a.length]}:a};v.draw=function(){D.graphers[this.type].call(this,this.opt)};v.prepareCanvas=function(a,b){var c=this.canvas;c||(this.canvas=c=p("<canvas class='canvis'>")[0],this.context=c.getContext("2d"),this.$el.hide().removeData("mouse").after(c));c.width=a;c.height=b;p(c).css({height:b,width:a}).data("canvis",this).off();return c};v.values=function(){var a=
function(a){return parseFloat(a)},b=arguments,c=this.$el.text().split(b[0]);return 1===b.length?c.map(a):c.map(function(c){return c.split(b[1]).map(a)})};var v={color:"#000",size:13,formatter:function(a){return a}},E={labelLevels:function(a){return u.max.apply(this,a.map(function(a){return a.replace(/[^ ]/g,"").length}))+1},toString:function(a,b){return b?a.map(function(a){return b(a)+""}):a.map(function(a){return a+""})},extractor:function(a){return function(b){return b[a]}},toFunction:function(a){return p.isArray(a)?
p.isArray(a[0])||p.isFunction(a[0])?a.map(function(a){return p.isFunction(a)?a:function(c,e){return a[e%a.length]}}):function(b,c){return a[c%a.length]}:a},getWidth:function(a,b){return a.measureText(b).width}},M=function(a){var b=this.getBoundingClientRect();p(this).off().prev().data("mouse",JSON.stringify({x:a.clientX-b.left,y:a.clientY-b.top})).change()},I=function(a){p(a).on("mousemove",M).on("mouseout",M)},y={arc:function(a,b,c,e,g,d,f,h){a.beginPath();a.arc(b,c,e,g,d,!0);a.lineWidth=h;a.strokeStyle=
f;a.stroke()},circle:function(a,b,c,e,g,d,f){a.beginPath();a.moveTo(b,c);a.arc(b,c,e,g,d,!0);a.fillStyle=f;a.fill()},line:function(a,b,c,e){a.beginPath();a.moveTo(b[0].x,b[0].y);for(var g=1;g<b.length;g++)a.lineTo(b[g].x,b[g].y);a.lineWidth=e;a.strokeStyle=c;a.stroke()},rect:function(a,b,c,e,g,d,f,h){d&&(a.fillStyle=d,a.fillRect(b,c,e,g));h&&(a.strokeStyle=h,a.lineWidth=f,a.strokeRect(b,c,e,g))},drawYAxis:function(a,b,c,e,g,d,f,h,l,r,q,n,A,x,w,s){var k=q-n*(0-A)+s;b&&y.line(a,[{x:l,y:k},{x:r,y:k}],
e,b);if(c)for(a.fillStyle=d,a.font=f+"px sans-serif",a.textAlign="right",b=A;b<=x;b+=w)k=q-n*(b-A)+s,y.line(a,[{x:l,y:k},{x:r,y:k}],g,c),l&&(a.textBaseline=k>f/2?k>q-f/2?"bottom":"middle":"top",a.fillText(h(b)+"",l-2,k))},drawXAxis:function(a,b,c,e,g,d){var f,h;a.fillStyle=b;a.font=c+"px sans-serif";a.textBaseline="top";a.textAlign="center";for(b=0;b<g.length;b++)for(h=d[b].split(" "),f=0;f<h.length;f++)a.fillText(h[f],g[b].x,e+1+f*c)},tooltip:function(a,b,c,e,g,d,f,h,l,r){a.font=d+"px sans-serif";
a.textAlign="left";a.textBaseline="top";e=E.toString(e,h);l&&e.splice(0,0,E.toString([l],r)[0]);var q=u.max.apply([],e.map(function(b){return E.getWidth(a,b)}));h=E.getWidth(a,"\u25a0");var n=q+h;b-=6;r=e.length*d;c>r-6&&(c-=r);b<=q+h+7&&(b+=q+h+20+7);y.rect(a,b-n-4,c-3,n+7,r+8,"#fff",1,"#000");l&&(a.fillStyle=f,a.fillText(e.splice(0,1)[0],b-n-2,c),c+=d);e.forEach(function(e,h){var l=c+h*d;a.fillStyle=g[h%g.length];a.fillText("\u25a0",b-n-3,l);a.fillStyle=f;a.fillText(e,b-q-2,l)})}};D.defaults={};
D.graphers={};D.register=function(a,b,c){this.defaults[a]=b;this.graphers[a]=c};D.register("pie",{fill:["#f90","#ffd","#fc6"],line:{color:"#000",width:0},focus:{color:"#000",width:0},delimiter:null,diameter:16,tooltip:v},function(a){var b=a.delimiter;b||(b=(b=this.$el.text().match(/[^0-9\.]/))?b[0]:",");var c=this.values.apply(this,[b]);"/"===b&&(c=[c[0],c[1]-c[0]]);var e,g=0,b=c.length;for(e=0;e<b;e++)g+=c[e];var d=this.$el.data("mouse"),f=a.focus,h=a.line,l=u.max(f.width,h.width)+1,r=a.diameter,
r=this.prepareCanvas(r+l,r+l),q=this.context;e=r.width;var n=r.height,l=e/2-l,A=2*u.PI,g=A/g,x=E.toFunction(a.fill);a=a.tooltip;var w;if(f.width&&d){d=JSON.parse(d);d.x-=e/2;d.y-=n/2;d.y*=-1;d.r=u.sqrt(d.x*d.x+d.y*d.y);for(d.a=u.atan2(d.y,d.x);0>d.a;)d.a+=A;for(;d.a>A;)d.a-=A}q.save();q.translate(e/2,n/2);var s,k=0;for(e=0;e<b;e++)n=c[e],s=n*g,y.circle(q,0,0,l,-k,-(k+s),x.call(this,n,e,c)),f.width&&d&&d.a>k&&d.a<k+s&&d.r<l&&(y.arc(q,0,0,l+f.width/2,-k,-(k+s),f.color,f.width),w=e),k+=s;h.width&&y.arc(q,
0,0,l+h.width/2,0,A,h.color,h.width);f.width&&(d&&void 0!==w&&(d=JSON.parse(this.$el.data("mouse")),q.restore(),y.tooltip(q,d.x,d.y,[c[w]],[x.call(this,c[w],w,c)],a.size,a.color,a.formatter)),I(r))});D.register("line",{lineColors:["#78A","#827"],lineWidths:[1],fill:"#cdf",delimiters:["|",","],height:32,width:32,left:0,max:null,min:0,pointSizes:[2],xAxis:v,yAxis:v,tooltip:v,focus:!1,gridlines:{widths:[1,0],colors:["#000","#bbb"]}},function(a){var b=this.$el.data("mouse"),c=this.values.apply(this,a.delimiters),
e,g=a.pointSizes,d=a.xAxis,f=a.yAxis,h=a.focus,l=a.tooltip,r=a.gridlines,q=[].concat.apply([a.max,a.min],c),n=a.labels,A=0;n&&(n=E.toString(n),A=E.labelLevels(n));var x=u.max.apply(u,q),w=u.min.apply(u,q),s=a.region||(x-w)/5,x=u.ceil(x/s)*s,w=u.floor(w/s)*s,q=this.prepareCanvas(a.width,a.height),k=this.context,p=a.left,B=A*d.size+(A?4:0),z=q.width,C=z-2*u.max.apply(u,g)-p,B=q.height-B,C=C/(c[0].length-0.5),v=B/(x-w),G=E.toFunction(a.lineColors),D=a.lineWidths,H=a.fill,m,t,K,F;a=[];for(t=0;t<c.length;t+=
1){K=c[t];F=[];for(m=0;m<K.length;m++)e=K[m],F.push({x:m*C+g[t%g.length]+p+C/4,y:B-v*(e-w)});if(H&&1===c.length){k.beginPath();e=0;k.moveTo(p+C/4+g[0],B-v*(e-w));for(m=0;m<F.length;m++)k.lineTo(F[m].x,F[m].y);e=0;k.lineTo(z-g[0]-C/4,B-v*(e-w));k.fillStyle=H;k.fill()}a.push(F)}y.drawYAxis(k,r.widths[0],r.widths[1],r.colors[0],r.colors[1],f.color,f.size,f.formatter,p,z,B,v,w,x,s,0);for(t=0;t<c.length;t+=1){F=a[t];G[t]=G.call(this,c[t][m],t,c[t]);for(m=0;m<F.length;m++)y.circle(k,F[m].x,F[m].y,g[t%g.length],
0,2*u.PI,G[t]);y.line(k,F,G[t],D[t%D.length])}A&&y.drawXAxis(k,d.color,d.size,B,a[0],n);if(h&&b)for(b=JSON.parse(b),m=0;m<a[0].length;m++)if(g=a[0][m],b.x>=g.x-C/3&&b.x<=g.x+C/3){y.tooltip(k,b.x,b.y,c.map(E.extractor(m)),G,l.size,l.color,l.formatter,n?n[m]:void 0,d.formatter);break}h&&I(q)});D.register("bar",{fill:[["#48f"],["#f90"],["#99f"]],delimiters:["|",","],height:16,width:32,left:0,gap:1,seriesGap:0,max:null,min:0,xAxis:v,yAxis:v,tooltip:v,focus:{color:"#000",width:0},gridlines:{widths:[1,
0],colors:["#000","#bbb"]}},function(a){var b=this,c=b.values.apply(b,a.delimiters),e=c.length,g=[].concat.apply([a.max,a.min],c),d,f,h,l=a.labels,r=0;l&&(l=E.toString(l),r=E.labelLevels(l));d=u.max.apply(u,g);g=u.min.apply(u,g);h=a.region||(d-g)/5;d=u.ceil(d/h)*h;var g=u.floor(g/h)*h,q=E.toFunction(a.fill),n=a.yAxis,p=a.xAxis,x=a.focus,w=a.tooltip,s=a.gridlines,k=b.$el.data("mouse"),v=b.prepareCanvas(a.width,a.height),B=b.context,z=v.width,C=a.gap,D=a.seriesGap;a=a.left;var G=v.height-(r*p.size+
(r?4:0))-s.widths[0],J=G/(d-g),H=(z-a-C*c[0].length)/c[0].length;y.drawYAxis(B,s.widths[0],s.widths[1],s.colors[0],s.colors[1],n.color,n.size,n.formatter,a,z,G,J,g,d,h,0);var m=[],t=[];for(f=0;f<c.length;f++){s=c[f];n=[];for(h=0;h<c[f].length;h++)t[h]={x:a+C/2+h*(C+H)+H/2},d=s[h],z=[a+C/2+h*(C+H)+H/e*f,G-J*(d-g),H/e-D/2,0===d?1:J*d],n.push(z),y.rect(B,z[0],z[1],z[2],z[3],q[f%q.length].call(b,d,h,c[f]),0);0===f&&n.slice(0);m.push(n.slice(0))}r&&y.drawXAxis(B,p.color,p.size,G,t,l);if(x.width&&k)for(k=
JSON.parse(k),f=0;f<m[0].length;f++)if(z=m[0][f],k.x>=z[0]&&k.x<=z[0]+H){for(h=0;h<m.length;h++)y.rect(B,m[h][f][0]-x.width/2,m[h][f][1]-x.width/2,m[h][f][2]+x.width,m[h][f][3]+x.width,void 0,x.width,x.color);y.tooltip(B,k.x,k.y,c.map(E.extractor(f)),c.map(function(a,c){return q[c].call(b,a[f],f,a)}),w.size,w.color,w.formatter,l?l[f]:void 0,p.formatter);break}x.width&&I(v)})})(jQuery,Math);
