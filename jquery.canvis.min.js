// Peity jQuery plugin version 1.2.1
// (c) 2013 Ben Pickles
// http://benpickles.github.io/peity
//
// CanVis jQuery plugin version 0.9.0
// (c) 2014 Fred Morel
// http://fmorel90.github.io/peity
//
// Released under MIT license.
(function(n,r){var O=document.createElement("canvas").getContext,v=n.fn.canvis=function(a,b){O&&this.each(function(){var c=n(this),e=c.data("canvis");if(e)a&&(e.type=a),n.extend(!0,e.opt,b),e.draw();else{var g=v.defaults[a],d={};n.each(c.data(),function(a,b){d[a]=b});g=n.extend({},g,d,b);e=new J(c,a,g);e.draw();c.change(function(){e.draw()}).data("canvis",e)}});return this},J=function(a,b,c){this.$el=a;this.type=b;this.opt=c},s=J.prototype;s.fill=function(){var a=this.opt.fill;return n.isArray(a)?
n.isArray(a[0])||n.isFunction(a[0])?a.map(function(a){return n.isFunction(a)?a:function(c,e){return a[e%a.length]}}):function(b,c){return a[c%a.length]}:a};s.draw=function(){v.graphers[this.type].call(this,this.opt)};s.prepareCanvas=function(a,b){var c=this.canvas;c||(this.canvas=c=n("<canvas class='canvis'>")[0],this.context=c.getContext("2d"),this.$el.hide().removeData("mouse").after(c));c.width=a;c.height=b;n(c).css({height:b,width:a}).data("canvis",this).off();return c};s.values=function(){var a=
function(a){return parseFloat(a)},b=arguments,c=this.$el.text().split(b[0]);return 1===b.length?c.map(a):c.map(function(c){return c.split(b[1]).map(a)})};var s={color:"#000",size:13,formatter:function(a){return a}},C={labelLevels:function(a){return r.max.apply(this,a.map(function(a){return a.replace(/[^ ]/g,"").length}))+1},toString:function(a,b){return b?a.map(function(a){return b(a)+""}):a.map(function(a){return a+""})},extractor:function(a){return function(b){return b[a]}},toFunction:function(a){return n.isArray(a)?
n.isArray(a[0])||n.isFunction(a[0])?a.map(function(a){return n.isFunction(a)?a:function(c,e){return a[e%a.length]}}):function(b,c){return a[c%a.length]}:a},getWidth:function(a,b){return a.measureText(b).width}},N=function(a){var b=this.getBoundingClientRect();n(this).off().prev().data("mouse",JSON.stringify({x:a.clientX-b.left,y:a.clientY-b.top})).change()},K=function(a){n(a).on("mousemove",N).on("mouseout",N)},y={arc:function(a,b,c,e,g,d,f,h){a.beginPath();a.arc(b,c,e,g,d,!0);a.lineWidth=h;a.strokeStyle=
f;a.stroke()},circle:function(a,b,c,e,g,d,f){a.beginPath();a.moveTo(b,c);a.arc(b,c,e,g,d,!0);a.fillStyle=f;a.fill()},line:function(a,b,c,e){a.beginPath();a.moveTo(b[0].x,b[0].y);for(var g=1;g<b.length;g++)a.lineTo(b[g].x,b[g].y);a.lineWidth=e;a.strokeStyle=c;a.stroke()},rect:function(a,b,c,e,g,d,f,h){d&&(a.fillStyle=d,a.fillRect(b,c,e,g));h&&(a.strokeStyle=h,a.lineWidth=f,a.strokeRect(b,c,e,g))},drawYAxis:function(a,b,c,e,g,d,f,h,l,w,q,p,E,r,x,t){var k=q-p*(0-E)+t;b&&y.line(a,[{x:l,y:k},{x:w,y:k}],
e,b);if(c)for(a.fillStyle=d,a.font=f+"px sans-serif",a.textAlign="right",b=E;b<=r;b+=x)k=q-p*(b-E)+t,y.line(a,[{x:l,y:k},{x:w,y:k}],g,c),l&&(a.textBaseline=k>f/2?k>q-f/2?"bottom":"middle":"top",a.fillText(h(b)+"",l-2,k))},drawXAxis:function(a,b,c,e,g,d){var f,h;a.fillStyle=b;a.font=c+"px sans-serif";a.textBaseline="top";a.textAlign="center";for(b=0;b<g.length;b++)for(h=d[b].split(" "),f=0;f<h.length;f++)a.fillText(h[f],g[b].x,e+1+f*c)},tooltip:function(a,b,c,e,g,d,f,h,l,w){a.font=d+"px sans-serif";
a.textAlign="left";a.textBaseline="top";e=C.toString(e,h);l&&e.splice(0,0,C.toString([l],w)[0]);var q=r.max.apply([],e.map(function(b){return C.getWidth(a,b)}));h=C.getWidth(a,"\u25a0");var p=q+h;b-=6;w=e.length*d;c>w-6&&(c-=w);b<=q+h+7&&(b+=q+h+20+7);y.rect(a,b-p-4,c-3,p+7,w+8,"#fff",1,"#000");l&&(a.fillStyle=f,a.fillText(e.splice(0,1)[0],b-p-2,c),c+=d);e.forEach(function(e,h){var l=c+h*d;a.fillStyle=g[h%g.length];a.fillText("\u25a0",b-p-3,l);a.fillStyle=f;a.fillText(e,b-q-2,l)})}};v.defaults={};
v.graphers={};v.register=function(a,b,c){this.defaults[a]=b;this.graphers[a]=c};v.register("pie",{fill:["#f90","#ffd","#fc6"],line:{color:"#000",width:0},focus:{color:"#000",width:0},delimiter:null,diameter:16,tooltip:s},function(a){var b=a.delimiter;b||(b=(b=this.$el.text().match(/[^0-9\.]/))?b[0]:",");var c=this.values.apply(this,[b]);"/"===b&&(c=[c[0],c[1]-c[0]]);var e,g=0,b=c.length;for(e=0;e<b;e++)g+=c[e];var d=this.$el.data("mouse"),f=a.focus,h=a.line,l=r.max(f.width,h.width)+1,w=a.diameter,
w=this.prepareCanvas(w+l,w+l),q=this.context;e=w.width;var p=w.height,l=e/2-l,E=2*r.PI,g=E/g,n=C.toFunction(a.fill);a=a.tooltip;var x;if(f.width&&d){d=JSON.parse(d);d.x-=e/2;d.y-=p/2;d.y*=-1;d.r=r.sqrt(d.x*d.x+d.y*d.y);for(d.a=r.atan2(d.y,d.x);0>d.a;)d.a+=E;for(;d.a>E;)d.a-=E}q.save();q.translate(e/2,p/2);var t,k=0;for(e=0;e<b;e++)p=c[e],t=p*g,y.circle(q,0,0,l,-k,-(k+t),n.call(this,p,e,c)),f.width&&d&&d.a>k&&d.a<k+t&&d.r<l&&(y.arc(q,0,0,l+f.width/2,-k,-(k+t),f.color,f.width),x=e),k+=t;h.width&&y.arc(q,
0,0,l+h.width/2,0,E,h.color,h.width);f.width&&(d&&void 0!==x&&(d=JSON.parse(this.$el.data("mouse")),q.restore(),y.tooltip(q,d.x,d.y,[c[x]],[n.call(this,c[x],x,c)],a.size,a.color,a.formatter)),K(w))});v.register("line",{lineColors:["#78A","#827"],lineWidths:[1],fill:"#cdf",delimiters:["|",","],height:32,width:32,left:0,max:null,min:0,pointSizes:[2],xAxis:s,yAxis:s,tooltip:s,focus:!1,gridlines:{widths:[1,0],colors:["#000","#bbb"]}},function(a){var b=this.$el.data("mouse"),c=this.values.apply(this,a.delimiters),
e,g=a.pointSizes,d=a.xAxis,f=a.yAxis,h=a.focus,l=a.tooltip,w=a.gridlines,q=[].concat.apply([a.max,a.min],c),p=a.labels,n=0;p&&(p=C.toString(p),n=C.labelLevels(p));var I=r.max.apply(r,q),x=r.min.apply(r,q),t=a.region||(I-x)/5,I=r.ceil(I/t)*t,x=r.floor(x/t)*t,q=this.prepareCanvas(a.width,a.height),k=this.context,s=a.left,A=n*d.size+(n?4:0),z=q.width,B=z-2*r.max.apply(r,g)-s,A=q.height-A,B=B/(c[0].length-0.5),v=A/(I-x),G=C.toFunction(a.lineColors),H=a.lineWidths,F=a.fill,m,u,M,D;a=[];for(u=0;u<c.length;u+=
1){M=c[u];D=[];for(m=0;m<M.length;m++)e=M[m],D.push({x:m*B+g[u%g.length]+s+B/4,y:A-v*(e-x)});if(F&&1===c.length){k.beginPath();e=0;k.moveTo(s+B/4+g[0],A-v*(e-x));for(m=0;m<D.length;m++)k.lineTo(D[m].x,D[m].y);k.lineTo(z-g[0]-B/4,A-v*(e-x));k.fillStyle=F;k.fill()}a.push(D)}y.drawYAxis(k,w.widths[0],w.widths[1],w.colors[0],w.colors[1],f.color,f.size,f.formatter,s,z,A,v,x,I,t,0);f=[];for(u=0;u<c.length;u+=1){D=a[u];f[u]=G.call(this,c[u][m],u,c[u]);for(m=0;m<D.length;m++)y.circle(k,D[m].x,D[m].y,g[u%
g.length],0,2*r.PI,f[u]);y.line(k,D,f[u],H[u%H.length])}n&&y.drawXAxis(k,d.color,d.size,A,a[0],p);if(h){if(b)for(b=JSON.parse(b),m=0;m<a[0].length;m++)if(g=a[0][m],b.x>=g.x-B/3&&b.x<=g.x+B/3){y.tooltip(k,b.x,b.y,c.map(C.extractor(m)),f,l.size,l.color,l.formatter,p?p[m]:void 0,d.formatter);break}K(q)}});v.register("bar",{fill:[["#48f"],["#f90"]],delimiters:["|",","],height:16,width:32,left:0,gap:1,seriesGap:0,max:null,min:0,xAxis:s,yAxis:s,tooltip:s,focus:{color:"#000",width:0},gridlines:{widths:[1,
0],colors:["#000","#bbb"]}},function(a){var b=this,c=b.values.apply(b,a.delimiters),e=c.length,g=[].concat.apply([a.max,a.min],c),d,f,h,l=a.labels,n=0;l&&(l=C.toString(l),n=C.labelLevels(l));d=r.max.apply(r,g);g=r.min.apply(r,g);h=a.region||(d-g)/5;d=r.ceil(d/h)*h;var g=r.floor(g/h)*h,q=C.toFunction(a.fill),p=a.yAxis,s=a.xAxis,v=a.focus,x=a.tooltip,t=a.gridlines,k=b.$el.data("mouse"),L=b.prepareCanvas(a.width,a.height),A=b.context,z=L.width,B=a.gap,J=a.seriesGap;a=a.left;var G=L.height-(n*s.size+
(n?4:0))-t.widths[0],H=G/(d-g),F=(z-a-B*c[0].length)/c[0].length;y.drawYAxis(A,t.widths[0],t.widths[1],t.colors[0],t.colors[1],p.color,p.size,p.formatter,a,z,G,H,g,d,h,0);var m=[],u=[];for(f=0;f<c.length;f++){t=c[f];p=[];for(h=0;h<c[f].length;h++)u[h]={x:a+B/2+h*(B+F)+F/2},d=t[h],z=[a+B/2+h*(B+F)+F/e*f,G-H*(d-g),F/e-J/2,0===d?1:H*d],p.push(z),y.rect(A,z[0],z[1],z[2],z[3],q[f%q.length].call(b,d,h,c[f]),0);0===f&&p.slice(0);m.push(p.slice(0))}n&&y.drawXAxis(A,s.color,s.size,G,u,l);if(v.width){if(k)for(k=
JSON.parse(k),f=0;f<m[0].length;f++)if(z=m[0][f],k.x>=z[0]&&k.x<=z[0]+F){for(h=0;h<m.length;h++)y.rect(A,m[h][f][0]-v.width/2,m[h][f][1]-v.width/2,m[h][f][2]+v.width,m[h][f][3]+v.width,void 0,v.width,v.color);y.tooltip(A,k.x,k.y,c.map(C.extractor(f)),c.map(function(a,c){return q[c].call(b,a[f],f,a)}),x.size,x.color,x.formatter,l?l[f]:void 0,s.formatter);break}K(L)}})})(jQuery,Math);
